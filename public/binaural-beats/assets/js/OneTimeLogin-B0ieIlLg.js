import{O as t,d as e,a8 as s,A as i}from"./dynamic-import-helper-CTnsj-vI.js";import{O as o}from"./onboarding-Di5GE543.js";import{o as a}from"./oneTimeLoginService-BFyldxb0.js";import{S as r}from"./SmoothReflow-QsxkeVSi.js";import{n}from"./_plugin-vue2_normalizer-DeUNqxFl.js";import"./array-YYQw31d9.js";import"./style-D-IRYiWS.js";import"./Logger-cMW5At62.js";import"./string-BBKP9xfj.js";import"./enums-1c3kgXdw.js";import"./helpers-BTpQmO5s.js";import"./TabLeaderElection-Ddi84wmm.js";import"./focusModeState-BPyBLUbE.js";import"./LocalStorageStoreSyncedItem-DMdfjgsv.js";import"./onboarding-B35lV45t.js";import"./compareObjects-R6Hcs7xe.js";import"./modal-BWwnzHDf.js";import"./SubscriptionSummary-BTlVYU_L.js";import"./persistStore-BDYPfxbs.js";import"./reactiveCustomization-CEUTOUc3.js";import"./VueBase-C55TLWt3.js";import"./_commonjsHelpers-B3K3fdV-.js";import"./ClickOutside-DCLvi2fj.js";import"./pinia-B4IAWUO-.js";import"./portal-vue.esm-DdddSpdW.js";import"./constants-CALDQiUE.js";import"./constants-BfBD_H-d.js";import"./authService-UjcjSrh8.js";import"./auth-BwdMrzFn.js";import"./legacyUserMigration-CaazFMYU.js";import"./migrateLegacyUserMessageHandler-CZ8nZZlg.js";import"./login-HJtMK9QU.js";import"./icon-confetti-BvRSomF2.js";import"./focusModeHelpers-tDECULZC.js";import"./PomodoroTimers-CyrfcuWH.js";import"./experiments-6paecGsK.js";import"./siteBlockerGroups-BbPmPcem.js";import"./constants-Dqx3dGLK.js";import"./SettingsTypes-BotgHBzA.js";import"./accessToken-Cx8MZLdN.js";import"./tasksMockData-CwjLszHJ.js";import"./tasksViewState-qOrGChOD.js";import"./ViewState-DH0LvQYq.js";import"./appZStack-Zxx-wHpo.js";import"./ResizeSensor-ZXOsDHeC.js";import"./useAllComponentsMounted-VdWDSwjD.js";const p=new i({feature:"one-time-login"});const l=n(t({name:"OneTimeLogin",components:{SmoothReflow:r},props:{subSteps:{type:Array,required:!0},activeSubStepIndex:{type:Number,required:!0},activeSubStep:{type:Object,required:!0},otlParams:{type:Object,default:void 0}},emits:["goToSubStep","dismiss","stepComplete"],setup:()=>({OneTimeLoginState:o,oneTimeLoginData:void 0,helpUrl:"https://get.momentumdash.help/hc/en-us/articles/19764520037143"}),data:()=>({processing:!1,errorResending:!1,emailSent:!1}),computed:{activeSubStepName(){var t;return(null==(t=this.activeSubStep)?void 0:t.name)??o.ERROR},resendButtonText(){return this.processing?"Processing…":"Re-send Link"}},async mounted(){var t;await this.redeemOneTimePassword();const s=e.userIsLegacyUnregistered()||!!localStorage.getItem("unregistered"),i=null==(t=this.oneTimeLoginData)?void 0:t.legacy;!s||i?await this.oneTimeLogin():this.setSubStep(o.UNSAVED_DATA)},methods:{setSubStep(t){const e=this.subSteps.findIndex((e=>e.name===t));-1!==e&&this.$emit("goToSubStep",e)},dismiss(){this.$emit("dismiss")},complete(){this.$emit("stepComplete")},displayErrorSubStep(t){var e;let i="string"==typeof t?t:"unknown error";t instanceof Error&&(null==t?void 0:t.message)&&(i=t.message);const a=s(t,{default:i});console.error(a),p.capture("one time login error",{message:a.message}),(null==(e=this.otlParams)?void 0:e.email)?this.setSubStep(o.ERROR_RESEND):this.setSubStep(o.ERROR)},goToRegistration(){m.cmd("modal.open","LOGIN",{force:!0})},async redeemOneTimePassword(){try{if(!this.otlParams)return this.displayErrorSubStep("no otl params defined");p.capture("one time password redeemed",{case:this.otlParams.ssoOutcome}),this.setSubStep(o.PROCESSING),a.startOneTimeLogin(),this.oneTimeLoginData=await a.redeemOneTimePassword(this.otlParams)}catch(t){this.displayErrorSubStep(t)}},async oneTimeLogin(){try{if(!this.oneTimeLoginData)return this.displayErrorSubStep("no one time login data");p.capture("one time login activated"),this.setSubStep(o.PROCESSING),await a.loginWithOneTimeLoginResponse(this.oneTimeLoginData),a.finalizeOneTimeLogin(),this.complete()}catch(t){this.displayErrorSubStep(t)}},reload(){location.reload()},async sendOtlEmail(){var t;this.errorResending=!1,this.emailSent=!1,this.processing=!0;const e=null==(t=this.otlParams)?void 0:t.email;try{if(!e)throw new Error("no email in params");await a.sendOneTimeLoginEmail(e),this.emailSent=!0}catch(s){console.error(s),this.errorResending=!0}finally{this.processing=!1}}}}),(function(){var t,e=this,s=e._self._c;return e._self._setupProxy,s("div",{staticClass:"one-time-login app reset-app-styles dark",attrs:{"data-test":"one-time-login"}},[s("transition",{attrs:{name:"fade",mode:"out-in",duration:350}},[s("div",{key:e.activeSubStepName,staticClass:"content",attrs:{"data-test":e.activeSubStepName}},[e.activeSubStepName===e.OneTimeLoginState.PROCESSING?[s("h2",[e._v("Logging you in to "+e._s(e.$partner.name)+"…")])]:e.activeSubStepName===e.OneTimeLoginState.UNSAVED_DATA?[s("h2",[e._v("Unsaved data found")]),s("p",[e._v("Create an account to save your data.")]),s("div",{staticClass:"actions"},[s("button",{staticClass:"dash-button dash-button-primary",attrs:{"data-test":"register"},on:{click:e.goToRegistration}},[e._v("Create account and save data")]),s("button",{staticClass:"dash-button",attrs:{"data-test":"proceed"},on:{click:e.oneTimeLogin}},[e._v("Continue without data")])]),s("div",{staticClass:"sub-actions"},[s("button",{attrs:{"data-test":"dismiss"},on:{click:e.dismiss}},[e._v("Cancel login")]),s("a",{attrs:{href:e.helpUrl}},[e._v("Help")])])]:e.activeSubStepName===e.OneTimeLoginState.ERROR_RESEND?[s("h2",[e._v("Your one-time login link has expired.")]),s("smooth-reflow",[e.errorResending?s("p",{key:"error",staticClass:"small"},[e._v("Oops, looks like something went wrong re-sending your link. Please ensure you are connected to the internet and try again. If the problem persists, please contact us.")]):e.emailSent?s("p",{key:"success",staticClass:"small"},[e._v("Your one-time login link has been sent! Please check your email.")]):s("p",{staticClass:"small"},[e._v("Re-send a one-time login link to "+e._s(null==(t=e.otlParams)?void 0:t.email)+".")])]),s("div",{staticClass:"actions horizontal"},[s("button",{staticClass:"dash-button dash-button-primary",on:{click:e.sendOtlEmail}},[e._v(e._s(e.resendButtonText))]),s("button",{staticClass:"dash-button",attrs:{"data-test":"dismiss"},on:{click:e.reload}},[e._v("Cancel")])]),s("div",{staticClass:"sub-actions"},[s("a",{attrs:{href:"https://momentumdash.com/contact","data-test":"contact-us"}},[e._v("Contact us")]),s("a",{attrs:{href:e.helpUrl}},[e._v("Help")])])]:e.activeSubStepName===e.OneTimeLoginState.ERROR?[s("h2",[e._v("Oops! Something didn't work")]),s("p",[e._v("If the problem persists, please contact us.")]),s("div",{staticClass:"actions horizontal"},[s("button",{staticClass:"dash-button dash-button-primary",attrs:{"data-test":"dismiss"},on:{click:e.reload}},[e._v("Dismiss")]),s("a",{staticClass:"dash-button",attrs:{href:"https://momentumdash.com/contact","data-test":"contact-us"}},[e._v("Contact us")])]),s("div",{staticClass:"sub-actions"},[s("a",{attrs:{href:e.helpUrl}},[e._v("Help")])])]:e._e()],2)])],1)}),[],!1,null,"9e897fdc").exports;export{l as default};
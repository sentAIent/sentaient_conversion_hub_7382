import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as W}from"./preload-helper-D7HrI6pR.js";class rt{constructor(){this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d",{alpha:!1}),this.config={maxConnectDist:180,starBaseRad:3.5,minGroupSize:3,bgColor:"#020205",showBackground:!0},this.worldSize=12e3,this.sectorSize=1e4,this.loadedSectors=new Map,this.currentSector={x:0,y:0},this.generationBoundary=3e3,this.stars=[],this.camera={x:0,y:0,zoom:1,targetZoom:1},this.history=[],this.mode="draw",this.activeColor="#00f3ff",this.colorMode="fixed",this.activeStyles=new Set,this.matrixSpeedMultiplier=1,this.matrixLengthMultiplier=1,this.matrixColor="#00ff00",this.matrixRainbowMode=!1,this.matrixAngle=0,this.starColors=["#ffffff","#aaddff","#ffddaa"],this.bgDriftMode=!1,this.bgWarpMode=!1,this.warpSpeed=0,this.warpSpeedMultiplier=1,this.warpStartTime=0,this.shootingStarsActive=[],this.lastShootingStarTime=0,this.flightMode=!1,this.keysPressed={},this.credits=this.loadCredits();const t=this.loadUpgrades();this.playerShip={type:"default",x:0,y:0,z:0,vx:0,vy:0,vz:0,rotation:0,pitch:0,roll:0,speed:0,maxSpeed:50*(1+(t.speed||0)*.2),acceleration:.5*(1+(t.speed||0)*.1),rotationSpeed:.08,size:45,hullHealth:100*(1+(t.armor||0)*.2),maxHull:100*(1+(t.armor||0)*.2),shield:50*(1+(t.shield||0)*.2),maxShield:50*(1+(t.shield||0)*.2),radarRange:2e3*(1+(t.radar||0)*.3),upgrades:t},this.speedLines=[],this.showGemValues=!1,this.minerals=[],this.mineralTypes={iron:{name:"Iron",value:10,color:"#8B8680",rarity:"common",size:15,zone:"industrial",use:"Basic construction"},copper:{name:"Copper",value:25,color:"#B87333",rarity:"common",size:15,zone:"industrial",use:"Wiring, conductors"},coal:{name:"Coal",value:15,color:"#36454F",rarity:"common",size:12,zone:"industrial",use:"Fuel source"},titanium:{name:"Titanium",value:80,color:"#878681",rarity:"common",size:16,zone:"industrial",use:"Armor plating"},silicon:{name:"Silicon",value:45,color:"#A0A0A0",rarity:"common",size:14,zone:"industrial",use:"Electronics, circuits"},silver:{name:"Silver",value:150,color:"#C0C0C0",rarity:"uncommon",size:18,zone:"precious",use:"Currency, conductors"},gold:{name:"Gold",value:400,color:"#FFD700",rarity:"uncommon",size:20,zone:"precious",use:"Electronics, currency"},platinum:{name:"Platinum",value:500,color:"#E5E4E2",rarity:"uncommon",size:20,zone:"precious",use:"Catalysts, jewelry"},palladium:{name:"Palladium",value:600,color:"#CED0DD",rarity:"uncommon",size:19,zone:"precious",use:"Fuel cells, catalysts"},quartz:{name:"Quartz",value:800,color:"#F5F5F5",rarity:"rare",size:22,zone:"crystal",use:"Optics, sensors"},diamond:{name:"Diamond",value:2500,color:"#B9F2FF",rarity:"rare",size:25,zone:"crystal",use:"Cutting tools, lasers"},emerald:{name:"Emerald",value:3e3,color:"#50C878",rarity:"rare",size:25,zone:"crystal",use:"Energy focusing"},ruby:{name:"Ruby",value:2800,color:"#E0115F",rarity:"rare",size:25,zone:"crystal",use:"Laser amplification"},sapphire:{name:"Sapphire",value:3200,color:"#0F52BA",rarity:"rare",size:25,zone:"crystal",use:"Shield technology"},uranium:{name:"Uranium",value:8e3,color:"#4AFF00",rarity:"epic",size:28,zone:"nuclear",use:"Nuclear reactors"},plutonium:{name:"Plutonium",value:12e3,color:"#00FF7F",rarity:"epic",size:28,zone:"nuclear",use:"Advanced power"},helium3:{name:"Helium-3",value:15e3,color:"#87CEEB",rarity:"epic",size:26,zone:"nuclear",use:"Fusion reactors"},neodymium:{name:"Neodymium",value:25e3,color:"#FF6EC7",rarity:"legendary",size:30,zone:"exotic",use:"Magnet tech"},lanthanum:{name:"Lanthanum",value:3e4,color:"#9D00FF",rarity:"legendary",size:32,zone:"exotic",use:"Hybrid engines"},darkmatter:{name:"Dark Matter",value:1e5,color:"#1a0033",rarity:"mythic",size:35,zone:"exotic",use:"Warp drives"},antimatter:{name:"Antimatter",value:15e4,color:"#FF00FF",rarity:"mythic",size:35,zone:"exotic",use:"Annihilation power"}},this.galaxyZones={industrial:{name:"Industrial Sector",color:"#8B8680",glowColor:"rgba(139, 134, 128, 0.3)",elements:["iron","copper","coal","titanium","silicon"],concentrationBonus:3,defenseLevel:1,distanceRange:{min:100,max:800}},precious:{name:"Precious Nebula",color:"#FFD700",glowColor:"rgba(255, 215, 0, 0.3)",elements:["silver","gold","platinum","palladium"],concentrationBonus:2.5,defenseLevel:2,distanceRange:{min:800,max:2e3}},crystal:{name:"Crystal Fields",color:"#50C878",glowColor:"rgba(80, 200, 120, 0.3)",elements:["quartz","diamond","emerald","ruby","sapphire"],concentrationBonus:2,defenseLevel:3,distanceRange:{min:2e3,max:4e3}},nuclear:{name:"Radiation Belt",color:"#4AFF00",glowColor:"rgba(74, 255, 0, 0.4)",elements:["uranium","plutonium","helium3"],concentrationBonus:1.5,defenseLevel:4,distanceRange:{min:3500,max:5e3}},exotic:{name:"Dark Frontier",color:"#9D00FF",glowColor:"rgba(157, 0, 255, 0.4)",elements:["neodymium","lanthanum","darkmatter","antimatter"],concentrationBonus:1,defenseLevel:5,distanceRange:{min:5e3,max:8e3}}},this.resourceDeposits=[],this.sentinels=[],this.forcefields=[],this.turrets=[],this.guardians=[],this.projectiles=[],this.playerInventory=this.loadInventory(),this.collectionNotifications=[];try{const e=localStorage.getItem("matrixThemeHistory");this.themeHistory=e?JSON.parse(e):[],this.lastMatrixFamily=localStorage.getItem("matrixLastFamily")||""}catch{this.themeHistory=[],this.lastMatrixFamily=""}this.staticStars=[],this.galaxies=[],this.blackHoles=[],this.shootingStars=[],this.backgroundStars=[],this.nebulae=[],this.spacecraft=[],this.matrixStreams=[],this.planets=[],this.rotationX=0,this.rotationY=0,this.rotationZ=0,this.pointer={x:0,y:0,startX:0,startY:0,isDown:!1,dragging:!1,lastWorldX:0,lastWorldY:0},this.hoveredStar=null,this.draggedStar=null,this.draggedClusterId=null,this.initNameGenerators(),this.initNameGenerators(),this.initTemplates(),this.generateResourceDeposits(),this.backgroundStars=[],this.init()}async initTemplates(){try{const[t,e,i]=await Promise.all([W(()=>import("./zodiac-DQUzN8_K.js"),[]).then(l=>l.default),W(()=>import("./animals-CEFkB1xx.js"),[]).then(l=>l.default),W(()=>import("./mythology-CiQ8dMlk.js"),[]).then(l=>l.default)]);this.templates={zodiac:t,animals:e,mythology:i};const a=(l,r,o)=>{const n=document.createElement("button");n.className="btn-small",n.style.margin="2px",n.style.textTransform="capitalize",n.innerText=r,n.onclick=()=>this.loadTemplate(l,r),document.getElementById(o).appendChild(n)};this.templates.zodiac&&Object.keys(this.templates.zodiac).forEach(l=>a("zodiac",l,"zodiacTemplates")),this.templates.animals&&Object.keys(this.templates.animals).forEach(l=>a("animals",l,"animalTemplates")),this.templates.mythology&&Object.keys(this.templates.mythology).forEach(l=>a("mythology",l,"mythTemplates"))}catch(t){console.error("Template loading failed:",t),this.showToast("Failed to load templates")}}loadTemplate(t,e){var v,w;const i=this.templates[t][e];if(!i)return;this.saveState();let a=0,l=0,r=0;i.forEach(S=>{a+=S[0],l+=S[1],r+=S[2]||0});const o=i.length,n=a/o,s=l/o,m=r/o;this.camera={x:0,y:0,zoom:1};const c=0,h=0,d=3,g=(v=document.getElementById("templateRainbowMode"))==null?void 0:v.checked,f=((w=document.getElementById("templateColorPicker"))==null?void 0:w.value)||"#00ffff",u=e.charAt(0).toUpperCase()+e.slice(1);let y=u;try{if(this.prefixes||this.initNameGenerators(),this.prefixes&&this.prefixes.length>0)if(Math.random()>.5)y=`${this.prefixes[Math.floor(Math.random()*this.prefixes.length)]} ${u}`;else{const S=this.suffixes[Math.floor(Math.random()*this.suffixes.length)];y=`${u} ${S}`}}catch(S){console.warn("Name gen failed",S)}const p=i.map((S,x)=>{let b=0,M=S[0]-n,C=S[1]-s,z=(S[2]||0)-m;if(S.length>=3)b=z*d;else{const E=Math.sqrt(M*M+C*C);b=-(E*E)*.05*d}return{id:Date.now()+x,x:c+M*d,y:h+C*d,z:b,color:g?this.getRainbowHex():f,phase:Math.random()*Math.PI*2,clusterId:y}});this.stars=p,document.getElementById("templatePanel").style.display="none",this.showToast(`Loaded ${e} template`),this.draw()}initNameGenerators(){this.prefixes=["Alpha","Beta","Gamma","Delta","Neo","Proto","Hyper","Cyber","Dark","Lost","Royal","Azure","Crimson","Void","Solar","Lunar","Emerald","Obsidian"],this.roots=["Orion","Cygnus","Draco","Lyra","Vela","Hydra","Cetus","Lupus","Pavo","Volans","Aries","Leo","Gemini","Ursa","Vortex","Helix","Prism","Shard","Echo","Serpens","Phoenix"],this.suffixes=["Major","Minor","Prime","Zero","Cluster","Nebula","Expanse","Quadrant","Sector","Knot","Web","Crown","Trident","Gate","Symphony","Paradox"]}init(){window.addEventListener("resize",()=>this.resize()),this.canvas.addEventListener("pointerdown",s=>this.onPointerDown(s)),window.addEventListener("pointermove",s=>this.onPointerMove(s)),window.addEventListener("pointerup",s=>this.onPointerUp(s)),this.canvas.addEventListener("wheel",s=>this.onWheel(s),{passive:!1}),this.canvas.addEventListener("contextmenu",s=>this.onRightClick(s)),window.addEventListener("keydown",s=>{if((s.ctrlKey||s.metaKey)&&s.key==="z"){s.preventDefault(),this.undo();return}if(this.flightMode){const m=s.key.toLowerCase();m==="u"?this.toggleUpgradePanel():this.keysPressed[m]=!0,s.preventDefault()}}),window.addEventListener("keyup",s=>{if(this.flightMode){const m=s.key.toLowerCase();this.keysPressed[m]=!1}}),this.setMode("draw"),this.updateColorModeUI(),this.matrixColorCustomized=!1,this.initDraggableWindows(),this.initDraggableWindows(),this.initDraggableWindows();const t=document.getElementById("matrixSpeedSlider");t&&t.addEventListener("input",s=>{this.matrixSpeedMultiplier=parseFloat(s.target.value),document.getElementById("matrixSpeedValue").textContent=this.matrixSpeedMultiplier.toFixed(1)+"x"});const e=document.getElementById("matrixLengthSlider");e&&e.addEventListener("input",s=>{this.matrixLengthMultiplier=parseFloat(s.target.value),document.getElementById("matrixLengthValue").textContent=this.matrixLengthMultiplier.toFixed(1)+"x"});const i=document.getElementById("matrixAngleSlider");i&&i.addEventListener("input",s=>{this.matrixAngle=parseInt(s.target.value),document.getElementById("matrixAngleValue").textContent=this.matrixAngle+"Â°"});const a=document.getElementById("matrixColorPicker"),l=document.getElementById("matrixColorHex");a&&a.addEventListener("input",s=>{this.matrixColor=s.target.value,this.matrixColorCustomized=!0,l&&(l.value=s.target.value),this.matrixStreams&&this.matrixStreams.forEach(m=>m.color=this.matrixColor)}),l&&l.addEventListener("input",s=>{let m=s.target.value;m.match(/^#[0-9A-Fa-f]{6}$/)&&(this.matrixColor=m,this.matrixColorCustomized=!0,a&&(a.value=m),this.matrixStreams&&this.matrixStreams.forEach(c=>c.color=this.matrixColor))});const r=document.getElementById("rotXSlider"),o=document.getElementById("rotYSlider"),n=document.getElementById("rotZSlider");r&&r.addEventListener("input",s=>{this.rotationX=parseFloat(s.target.value),document.getElementById("rotXValue").textContent=this.rotationX+"Â°"}),o&&o.addEventListener("input",s=>{this.rotationY=parseFloat(s.target.value),document.getElementById("rotYValue").textContent=this.rotationY+"Â°"}),n&&n.addEventListener("input",s=>{this.rotationZ=parseFloat(s.target.value),document.getElementById("rotZValue").textContent=this.rotationZ+"Â°"}),this.resize(),window.addEventListener("resize",()=>this.resize()),this.animate=this.animate.bind(this),requestAnimationFrame(this.animate)}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.staticStars=[],this.generateStaticStars(),this.draw()}generateStaticBackground(){const t=[];for(let i=0;i<300;i++)t.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,size:Math.random()*.5+.1,alpha:Math.random()*.5+.2});return t}initDraggableWindows(){const t=e=>{const i=document.getElementById(e);if(!i)return;const a=i.querySelector(".window-header, .cockpit-header");if(!a)return;let l=!1,r,o,n,s;a.style.cursor="grab",a.addEventListener("mousedown",m=>{l=!0,a.style.cursor="grabbing",i.style.zIndex="1000",r=m.clientX,o=m.clientY;const c=i.getBoundingClientRect();n=c.left,s=c.top,m.preventDefault()}),window.addEventListener("mousemove",m=>{if(!l)return;const c=m.clientX-r,h=m.clientY-o;i.style.left=n+c+"px",i.style.top=s+h+"px",i.style.bottom="auto",i.style.right="auto"}),window.addEventListener("mouseup",()=>{l=!1,a.style.cursor="grab"})};t("floatingMap"),t("floatingLeaders"),t("sectionControls"),t("sectionRadar"),t("sectionVelocity"),t("sectionGems")}setMode(t){this.mode=t,document.getElementById("drawModeBtn").classList.remove("active"),document.getElementById("selectModeBtn").classList.remove("active"),t==="draw"?(document.getElementById("drawModeBtn").classList.add("active"),this.canvas.style.cursor="crosshair"):t==="select"&&(document.getElementById("selectModeBtn").classList.add("active"),this.canvas.style.cursor="pointer")}getRainbowHex(){return"#"+Math.floor(Math.random()*16777215).toString(16).padStart(6,"0")}setFixedColor(t){this.activeColor=t,this.colorMode="fixed",this.updateColorModeUI(),this.showToast(`Active color set to ${t}`)}setRainbowMode(){this.colorMode="rainbow",this.updateColorModeUI(),this.showToast("Active color set to Rainbow Mode ðŸŒˆ")}seededRandom(t){const e=Math.sin(t)*1e4;return e-Math.floor(e)}getSectorCoords(t,e){return{x:Math.floor(t/this.sectorSize),y:Math.floor(e/this.sectorSize)}}getSectorSeed(t,e){return t*73856093^e*19349663}checkAndGenerateSectors(){if(!this.flightMode)return;const t=this.getSectorCoords(this.playerShip.x,this.playerShip.y);this.currentSector=t;for(let e=-1;e<=1;e++)for(let i=-1;i<=1;i++){const a=t.x+e,l=t.y+i,r=`${a},${l}`;this.loadedSectors.has(r)||this.generateSector(a,l)}for(const[e]of this.loadedSectors.entries()){const[i,a]=e.split(",").map(Number);if(Math.max(Math.abs(i-t.x),Math.abs(a-t.y))>2){const r=this.loadedSectors.get(e);r&&(this.minerals=this.minerals.filter(o=>!r.minerals.includes(o)),this.resourceDeposits=this.resourceDeposits.filter(o=>!r.deposits.includes(o))),this.loadedSectors.delete(e)}}}generateSector(t,e){var m;const i=`${t},${e}`;if(this.loadedSectors.has(i))return;console.log(`[Universe] Generating sector (${t}, ${e})`);const a=this.getSectorSeed(t,e),l={x:t,y:e,minerals:[],deposits:[]},r=t*this.sectorSize;(t+1)*this.sectorSize;const o=e*this.sectorSize;(e+1)*this.sectorSize;const n=Math.floor(100+this.seededRandom(a+1)*200);for(let c=0;c<n;c++){const h=a+c*1e3,d=r+this.seededRandom(h)*this.sectorSize,g=o+this.seededRandom(h+1)*this.sectorSize,f=Math.hypot(d,g);let u="iron";const y=this.seededRandom(h+2);f<1e3?u=["iron","copper","coal","titanium","silicon"][Math.floor(y*5)]:f<3e3?u=["silver","gold","platinum","palladium"][Math.floor(y*4)]:f<6e3?u=["quartz","diamond","emerald","ruby","sapphire"][Math.floor(y*5)]:f<1e4?u=["uranium","plutonium","helium3"][Math.floor(y*3)]:u=["neodymium","lanthanum","darkmatter","antimatter"][Math.floor(y*4)];const p=this.mineralTypes[u];if(!p)continue;const v={x:d,y:g,type:u,color:p.color,size:p.size,value:p.value};this.minerals.push(v),l.minerals.push(v)}const s=Math.floor(3+this.seededRandom(a+5e5)*5);for(let c=0;c<s;c++){const h=a+5e5+c*2e3,d=r+this.seededRandom(h)*this.sectorSize,g=o+this.seededRandom(h+1)*this.sectorSize,f=Math.hypot(d,g);let u="industrial";f>=8e3?u="exotic":f>=5e3?u="nuclear":f>=2500?u="crystal":f>=1e3&&(u="precious");const y=.3+this.seededRandom(h+2)*.7,p={x:d,y:g,zone:u,name:`${((m=this.galaxyZones[u])==null?void 0:m.name)||u} Deposit`,richness:y,tier:Math.floor(y*3)+1};this.resourceDeposits.push(p),l.deposits.push(p)}this.loadedSectors.set(i,l),console.log(`[Universe] Sector (${t}, ${e}): ${n} minerals, ${s} deposits`)}toggleBgStyle(t){console.log(`[BG Toggle] ${t}, currently active:`,this.activeStyles.has(t)),this.activeStyles.has(t)?(this.activeStyles.delete(t),this.clearStyleData(t)):(this.activeStyles.add(t),this.generateSingleStyle(t)),this.updateBgUI(),this.generateStaticStars()}generateSingleStyle(t){switch(t){case"deep-space":this.generateDeepSpaceStyle();break;case"nebula":this.generateNebulaStyle();break;case"alien":this.generateAlienStyle();break;case"cyber":this.generateCyberStyle();break}}clearStyleData(t){switch(t){case"deep-space":this.galaxies=[],this.blackHoles=[],this.planets=[];break;case"nebula":this.nebulae=[];break;case"alien":this.spacecraft=[];break;case"cyber":this.matrixStreams=[];break}}updateBgUI(){document.querySelectorAll(".bg-toggle").forEach(e=>{const i=e.getAttribute("data-style");this.activeStyles.has(i)?e.classList.add("active"):e.classList.remove("active")});const t=document.getElementById("matrixPanel");t&&(this.activeStyles.has("cyber")?t.classList.remove("hidden"):t.classList.add("hidden"))}toggleRotationPanel(){const t=document.getElementById("rotationPanel");t&&t.classList.toggle("hidden")}toggleTemplatePanel(){const t=document.getElementById("templatePanel");t.style.display==="block"?t.style.display="none":t.style.display="block"}toggleFlightMode(){this.flightMode=!this.flightMode;const t=document.getElementById("flightHUD"),e=document.getElementById("floatingMap"),i=document.getElementById("floatingLeaders");this.flightMode?(t&&t.classList.remove("hidden"),e&&e.classList.remove("hidden"),i&&i.classList.remove("hidden"),this.updateFloatingLeaderboard()):(t&&t.classList.add("hidden"),e&&e.classList.add("hidden"),i&&i.classList.add("hidden")),this.flightMode&&this.activeStyles.size===0&&this.toggleBgStyle("deep-space"),this.showToast(this.flightMode?"Flight Mode: ON - Use WASD/QE/Shift":"Flight Mode: OFF");const a=document.getElementById("selectShipBtn");a&&(a.style.display=this.flightMode?"inline-flex":"none"),this.draw()}toggleCockpitSection(t){const e=document.getElementById(t);e&&e.classList.toggle("collapsed")}toggleGemValues(){this.showGemValues=!this.showGemValues,this.updateFlightHUD();const t=document.getElementById("btnToggleGemValues");t&&(t.style.background=this.showGemValues?"rgba(255,215,0,0.3)":"")}initGemsResize(){const t=document.getElementById("sectionGems"),e=t==null?void 0:t.querySelector(".resize-handle");if(!t||!e)return;let i=!1,a,l;e.addEventListener("mousedown",r=>{i=!0,a=r.clientX,l=t.offsetWidth,r.preventDefault()}),window.addEventListener("mousemove",r=>{if(!i)return;const o=l+(r.clientX-a),n=Math.max(200,Math.min(800,o));t.style.width=n+"px"}),window.addEventListener("mouseup",()=>{i=!1})}toggleFloatingWindow(t){const e=document.getElementById(t);e&&e.classList.toggle("collapsed")}getGemEmoji(t){return""}styleGem(t){const e=this.mineralTypes[t];return e?`background: radial-gradient(circle at 30% 30%, #fff 10%, ${e.color} 60%);
                        box-shadow: 0 0 4px ${e.color};
                        border-radius: 50%;
                        width: 12px; 
                        height: 12px;
                        display: inline-block;`:""}updateFlightHUD(){if(!this.flightMode)return;const t=document.getElementById("speedNumber"),e=document.getElementById("zoomDisplay");t&&(t.textContent=Math.round(this.playerShip.speed)),e&&(e.textContent=this.camera.zoom.toFixed(1)+"x");const i=document.getElementById("radarCoords");i&&(i.textContent=`X: ${Math.round(this.playerShip.x)} Y: ${Math.round(this.playerShip.y)}`);const a=document.getElementById("gemsGrid"),l=document.getElementById("gemsTotal"),r=document.getElementById("creditsDisplay");if(r&&(r.textContent="$"+this.credits.toLocaleString()),a){let o=0,n="";const s=Object.entries(this.playerInventory||{});s.length===0?n='<div style="color:#5c7a8a;font-size:9px;padding:4px;">No gems yet</div>':s.forEach(([m,c])=>{if(c<=0)return;const h=this.mineralTypes[m];if(!h)return;o+=c*h.value;const d=c*h.value,g=this.showGemValues?`<span style="color:${h.color}; font-weight:bold; margin-left:6px;">$${Math.round(d).toLocaleString()}</span>`:"";n+=`
                                <div class="gem-item" style="border:1px solid ${h.color}44; background: rgba(0,0,0,0.6);">
                                    <div style="${this.styleGem(m)}"></div>
                                    <span style="color:${h.color}">${h.name}</span>
                                    <span class="gem-count">Ã—${c}</span>
                                    ${g}
                                </div>
                            `}),a.innerHTML=n,l&&(l.textContent=`$${o.toLocaleString()}`)}this.updateRadar(),this.updateMap(),this.initGemsResize()}updateRadar(){const t=document.getElementById("radarCanvas");if(!t)return;const e=t.getContext("2d"),i=t.width,a=t.height,l=i/2,r=a/2;e.clearRect(0,0,i,a),e.strokeStyle="rgba(0,255,100,0.2)",e.lineWidth=1,e.beginPath(),e.moveTo(l,0),e.lineTo(l,a),e.moveTo(0,r),e.lineTo(i,r),e.arc(l,r,20,0,Math.PI*2),e.arc(l,r,35,0,Math.PI*2),e.stroke(),e.fillStyle="#0f0",e.beginPath(),e.arc(l,r,3,0,Math.PI*2),e.fill();const o=2e3;this.minerals.forEach(n=>{const s=n.x-this.playerShip.x,m=n.y-this.playerShip.y;if(Math.sqrt(s*s+m*m)<o){const h=l+s/o*35,d=r+m/o*35;e.fillStyle=n.color||"#f0f",e.beginPath(),e.arc(h,d,2,0,Math.PI*2),e.fill()}})}generateResourceDeposits(){this.resourceDeposits=[];for(let t=0;t<12;t++){const e=t/12*Math.PI*2+Math.random()*.2,i=2e3+Math.random()*2e3;this.resourceDeposits.push({x:Math.cos(e)*i,y:Math.sin(e)*i,z:(Math.random()-.5)*400,zone:"industrial",radius:700,richness:1.5,tier:1,value:"low",name:`Common Field ${t+1}`})}for(let t=0;t<10;t++){const e=t/10*Math.PI*2+Math.random()*.3,i=5e3+Math.random()*3e3,a=Math.random()<.5?"precious":"crystal";this.resourceDeposits.push({x:Math.cos(e)*i,y:Math.sin(e)*i,z:(Math.random()-.5)*600,zone:a,radius:800,richness:2,tier:2,value:"medium",name:`Rich Cluster ${t+1}`})}for(let t=0;t<8;t++){const e=t/8*Math.PI*2+Math.random()*.4,i=1e4+Math.random()*5e3,a=Math.random()<.5?"nuclear":"crystal";this.resourceDeposits.push({x:Math.cos(e)*i,y:Math.sin(e)*i,z:(Math.random()-.5)*800,zone:a,radius:900,richness:3,tier:3,value:"high",name:`Epic Cache ${t+1}`})}for(let t=0;t<6;t++){const e=t/6*Math.PI*2+Math.random()*.5,i=18e3+Math.random()*7e3;this.resourceDeposits.push({x:Math.cos(e)*i,y:Math.sin(e)*i,z:(Math.random()-.5)*1e3,zone:"nuclear",radius:1e3,richness:4.5,tier:4,value:"legendary",name:`Legendary Cache ${t+1}`})}for(let t=0;t<4;t++){const e=t/4*Math.PI*2+Math.random()*.6,i=28e3+Math.random()*1e4;this.resourceDeposits.push({x:Math.cos(e)*i,y:Math.sin(e)*i,z:(Math.random()-.5)*1500,zone:"exotic",radius:1200,richness:6,tier:5,value:"mythic",name:`Mythic Treasure ${t+1}`})}for(let t=0;t<3;t++){const e=t/3*Math.PI*2+Math.random()*.8,i=42e3+Math.random()*8e3;this.resourceDeposits.push({x:Math.cos(e)*i,y:Math.sin(e)*i,z:(Math.random()-.5)*2e3,zone:"exotic",radius:1500,richness:8,tier:6,value:"ultra-mythic",name:`Galaxy Core ${t+1}`})}console.log(`[Universe] Generated ${this.resourceDeposits.length} gem clusters across 50,000 units`)}updateMap(){const t=document.getElementById("mapCanvas");if(!t)return;const e=t.getContext("2d"),i=t.width,a=t.height,l=i/2,r=a/2,n=Math.min(i,a)/2/5e4;e.fillStyle="rgba(0,5,20,0.95)",e.fillRect(0,0,i,a);const s=-this.playerShip.x,m=-this.playerShip.y;Object.values(this.galaxyZones).forEach(d=>{const g=d.distanceRange.min*n;e.beginPath(),e.arc(l+s*n,r+m*n,g,0,Math.PI*2),e.strokeStyle=d.color,e.globalAlpha=.3,e.lineWidth=1,e.stroke()}),this.resourceDeposits.forEach(d=>{const g=(d.x+s)*n,f=(d.y+m)*n;let u,y,p;switch(d.tier){case 1:u="#4488ff",y="#6699ff",p="C";break;case 2:u="#ff66ff",y="#ff88ff",p="R";break;case 3:u="#ffaa00",y="#ffcc44",p="E";break;case 4:u="#ff4400",y="#ff6644",p="L";break;case 5:u="#ff00ff",y="#ff44ff",p="M";break;case 6:u="#00ffff",y="#44ffff",p="G";break;default:u="#00f",y="#44f",p="?";break}const v=1+Math.sin(Date.now()*.003)*.3,w=(3+d.tier)*v;e.fillStyle=y,e.globalAlpha=.4,e.beginPath(),e.arc(l+g,r+f,w,0,Math.PI*2),e.fill(),e.globalAlpha=1,e.fillStyle=u,e.beginPath(),e.arc(l+g,r+f,3+d.tier*.5,0,Math.PI*2),e.fill(),e.fillStyle="#fff",e.font="bold 8px monospace",e.textAlign="center",e.fillText(p,l+g,r+f+w+8)}),this.minerals.forEach(d=>{const g=(d.x+s)*n,f=(d.y+m)*n;e.fillStyle=d.color,e.globalAlpha=.3,e.beginPath(),e.arc(l+g,r+f,4,0,Math.PI*2),e.fill(),e.globalAlpha=.9,e.beginPath(),e.arc(l+g,r+f,2.5,0,Math.PI*2),e.fill()}),e.globalAlpha=1;const c=l,h=r;this.playerShip.rotation+Math.PI/2,e.save(),e.translate(c,h),e.rotate(this.playerShip.rotation+Math.PI/2),e.fillStyle="#0f0",e.beginPath(),e.moveTo(0,-5),e.lineTo(4,4),e.lineTo(0,2),e.lineTo(-4,4),e.fill(),e.restore(),e.strokeStyle=`rgba(0, 255, 0, ${.5+Math.sin(Date.now()*.005)*.3})`,e.beginPath(),e.arc(c,h,8,0,Math.PI*2),e.stroke()}openExpandedMap(){console.log("[Expand Map] Button clicked!");const t=document.getElementById("expandedMapModal");if(console.log("[Expand Map] Modal element:",t),t&&(t.classList.remove("hidden"),this.expandedMapOpen=!0,this.expandedMapZoom=this.expandedMapZoom||1,this.expandedMapOffset=this.expandedMapOffset||{x:0,y:0},this.expandedMapOffset.x=-this.playerShip.x,this.expandedMapOffset.y=-this.playerShip.y,console.log("[Expand Map] Starting animation, zoom:",this.expandedMapZoom),this.animateExpandedMap(),!this.mapWheelListener)){this.mapWheelListener=i=>{i.preventDefault();const l=Math.max(.2,Math.min(10,this.expandedMapZoom-Math.sign(i.deltaY)*.1));this.expandedMapZoom=l,document.getElementById("mapZoomLevel").textContent=`Zoom: ${this.expandedMapZoom.toFixed(1)}x`};const e=document.getElementById("fullscreenMapCanvas");e.addEventListener("wheel",this.mapWheelListener),this.isDraggingMap=!1,this.lastMapMouse={x:0,y:0},e.addEventListener("mousedown",i=>{this.isDraggingMap=!0,this.lastMapMouse={x:i.clientX,y:i.clientY},e.style.cursor="grabbing"}),window.addEventListener("mousemove",i=>{if(!this.isDraggingMap)return;const a=i.clientX-this.lastMapMouse.x,l=i.clientY-this.lastMapMouse.y;this.lastMapMouse={x:i.clientX,y:i.clientY},this.expandedMapOffset.x+=a/this.expandedMapZoom,this.expandedMapOffset.y+=l/this.expandedMapZoom}),window.addEventListener("mouseup",()=>{this.isDraggingMap=!1,e.style.cursor="grab"})}}closeExpandedMap(){const t=document.getElementById("expandedMapModal");t&&(t.classList.add("hidden"),this.expandedMapOpen=!1)}animateExpandedMap(){if(!this.expandedMapOpen)return;const t=document.getElementById("fullscreenMapCanvas");if(!t){console.error("[Map Debug] Canvas not found");return}console.log("[Map Debug] Rendering expanded map, zoom:",this.expandedMapZoom),(t.width!==window.innerWidth||t.height!==window.innerHeight)&&(t.width=window.innerWidth,t.height=window.innerHeight);const e=t.getContext("2d"),i=t.width,a=t.height,l=i/2,r=a/2,o=this.expandedMapZoom,n=Date.now()*.001,s=e.createRadialGradient(l,r,0,l,r,Math.max(i,a));s.addColorStop(0,"#000810"),s.addColorStop(.6,"#000508"),s.addColorStop(1,"#000000"),e.fillStyle=s,e.fillRect(0,0,i,a),e.save(),e.translate(l,r),e.scale(o,o),e.translate(this.expandedMapOffset.x,this.expandedMapOffset.y),this.renderMapStars(e,.5,.5,5e3,15e3,"#445566"),this.renderMapStars(e,.3,.8,3e3,1e4,"#6688aa"),Object.values(this.galaxyZones).forEach(M=>{const C=M.distanceRange.min;e.beginPath(),e.arc(0,0,C,0,Math.PI*2),e.fillStyle=M.glowColor||M.color,e.globalAlpha=.03,e.lineWidth=100,e.fill(),e.beginPath(),e.arc(0,0,C,0,Math.PI*2),e.strokeStyle=M.color,e.lineWidth=2/o,e.globalAlpha=.2,e.setLineDash([20,40]),e.stroke(),e.setLineDash([]),e.fillStyle=M.color,e.font="bold 64px Orbitron",e.textAlign="center",e.globalAlpha=.4,e.fillText(M.name.toUpperCase(),0,-C+200)}),e.strokeStyle="rgba(0, 243, 255, 0.08)",e.lineWidth=1/o;const m=1e3,c=-this.expandedMapOffset.x,h=-this.expandedMapOffset.y,d=i/o,g=a/o,f=Math.floor((c-d)/m)*m,u=Math.floor((c+d)/m)*m,y=Math.floor((h-g)/m)*m,p=Math.floor((h+g)/m)*m;e.beginPath();for(let M=f;M<=u;M+=m)e.moveTo(M,y),e.lineTo(M,p);for(let M=y;M<=p;M+=m)e.moveTo(f,M),e.lineTo(u,M);e.stroke(),this.resourceDeposits.forEach(M=>{const C=1+Math.sin(n*3+M.x*.01)*.2,z=this.galaxyZones[M.zone]?this.galaxyZones[M.zone].color:"#fff",E=this.galaxyZones[M.zone]?this.galaxyZones[M.zone].glowColor||z:"#fff",P=e.createRadialGradient(M.x,M.y,5*C,M.x,M.y,30*C);P.addColorStop(0,E),P.addColorStop(1,"rgba(0,0,0,0)"),e.fillStyle=P,e.globalAlpha=.4,e.beginPath(),e.arc(M.x,M.y,40*C,0,Math.PI*2),e.fill(),e.globalAlpha=1,e.fillStyle=z;const I=12;e.beginPath(),e.moveTo(M.x,M.y-I),e.lineTo(M.x+I,M.y),e.lineTo(M.x,M.y+I),e.lineTo(M.x-I,M.y),e.closePath(),e.fill(),o>.8&&(e.fillStyle="#fff",e.font='14px "Segoe UI", sans-serif',e.textAlign="center",e.fillText(M.name,M.x,M.y+40),e.font='10px "Segoe UI", sans-serif',e.fillStyle="#aaa",e.fillText(`Richness: ${(M.richness*100).toFixed(0)}%`,M.x,M.y+55))}),this.minerals.forEach(M=>{const C=this.mineralTypes[M.type];C&&(e.globalAlpha=.4,e.fillStyle=C.color,e.beginPath(),e.arc(M.x,M.y,8/o,0,Math.PI*2),e.fill(),e.globalAlpha=1,e.beginPath(),e.arc(M.x,M.y,4/o,0,Math.PI*2),e.fill(),o>1.5&&(e.fillStyle="#fff",e.font=`${10/o}px Arial`,e.textAlign="center",e.fillText(C.name,M.x,M.y-10/o)))}),e.globalAlpha=1;const v=this.playerShip.x,w=this.playerShip.y;e.translate(v,w);const S=400;e.rotate(this.playerShip.rotation+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.arc(0,0,S,-Math.PI/6,Math.PI/6),e.fillStyle="rgba(0, 255, 100, 0.1)",e.fill(),e.strokeStyle="rgba(0, 255, 100, 0.3)",e.lineWidth=1,e.stroke(),e.beginPath(),e.moveTo(0,-20),e.lineTo(14,14),e.lineTo(0,8),e.lineTo(-14,14),e.closePath(),e.fillStyle="#0f0",e.shadowColor="#0f0",e.shadowBlur=15,e.fill(),e.shadowBlur=0,e.restore(),e.font="14px Consolas, monospace",e.fillStyle="rgba(0, 243, 255, 0.8)",e.textAlign="left",e.fillText(`SECTOR: [${Math.floor(v/5e3)}, ${Math.floor(w/5e3)}]`,20,a-60),e.fillText(`COORDS: X ${Math.round(v)}  Y ${Math.round(w)}`,20,a-40);const b=200/o;e.beginPath(),e.moveTo(i-220,a-40),e.lineTo(i-20,a-40),e.moveTo(i-220,a-45),e.lineTo(i-220,a-35),e.moveTo(i-20,a-45),e.lineTo(i-20,a-35),e.strokeStyle="#fff",e.lineWidth=2,e.stroke(),e.textAlign="center",e.fillStyle="#fff",e.fillText(`${Math.round(b)}km`,i-120,a-50),requestAnimationFrame(()=>this.animateExpandedMap())}renderMapStars(t,e,i,a,l,r){const o=-this.expandedMapOffset.x*i,n=-this.expandedMapOffset.y*i,s=t.canvas.width/this.expandedMapZoom,m=t.canvas.height/this.expandedMapZoom,c=Math.floor((o-s)/a),h=Math.floor((o+s)/a),d=Math.floor((n-m)/a),g=Math.floor((n+m)/a);t.fillStyle=r;for(let f=c;f<=h;f++)for(let u=d;u<=g;u++){const y=f*34234+u*23123,p=Math.sin(y)*a,v=Math.cos(y*.5)*a,w=Math.sin(y*1.5)+1.5;t.globalAlpha=e*(.5+Math.sin(y*.1)*.5),t.beginPath(),t.arc(f*a+p,u*a+v,w,0,Math.PI*2),t.fill()}t.globalAlpha=1}updateFloatingLeaderboard(){const t=document.getElementById("floatingLeadersList");if(!t)return;const e=[{name:"StarPilot99",wealth:125e3+Math.floor(Math.random()*1e4)},{name:"NebulaHunter",wealth:98e3+Math.floor(Math.random()*8e3)},{name:"AstroMiner",wealth:76e3+Math.floor(Math.random()*5e3)},{name:"You",wealth:this.calculateTotalWealth()}];e.sort((a,l)=>l.wealth-a.wealth);let i="";e.forEach((a,l)=>{const r=l===0?"ðŸ¥‡":l===1?"ðŸ¥ˆ":l===2?"ðŸ¥‰":"",o=a.name==="You";i+=`<div class="leader-row${o?" you":""}">
                        <span class="leader-rank">${r||l+1}</span>
                        <span class="leader-name">${a.name}</span>
                        <span class="leader-wealth">$${a.wealth.toLocaleString()}</span>
                    </div>`}),t.innerHTML=i}updateLeaderboard(){this.updateFloatingLeaderboard()}calculateTotalWealth(){let t=0;for(const[e,i]of Object.entries(this.playerInventory)){const a=this.mineralTypes[e];a&&(t+=a.value*i)}return t}updatePlayerShip(){const t=this.playerShip,e=this.keysPressed;(e.a||e.arrowleft)&&(t.rotation-=t.rotationSpeed),(e.d||e.arrowright)&&(t.rotation+=t.rotationSpeed),e.r&&(t.pitch=Math.min(Math.PI/3,t.pitch+.02)),e.f&&(t.pitch=Math.max(-Math.PI/3,t.pitch-.02)),e.z&&(t.roll=Math.min(Math.PI/2,t.roll+.03)),e.c&&(t.roll=Math.max(-Math.PI/2,t.roll-.03));const i=Math.cos(t.rotation),a=Math.sin(t.rotation);(e.w||e.arrowup)&&(t.vx+=i*t.acceleration,t.vy+=a*t.acceleration),(e.s||e.arrowdown)&&(t.vx-=i*t.acceleration*.5,t.vy-=a*t.acceleration*.5),e.q&&(t.vz+=t.acceleration),e.e&&(t.vz-=t.acceleration);const l=e.shift||e[" "]?2:1;if(t.x+=t.vx*l,t.y+=t.vy*l,t.z+=t.vz*l,t.speed=Math.sqrt(t.vx*t.vx+t.vy*t.vy+t.vz*t.vz),t.speed>t.maxSpeed){const o=t.maxSpeed/t.speed;t.vx*=o,t.vy*=o,t.vz*=o,t.speed=t.maxSpeed}const r=.995;if(t.vx*=r,t.vy*=r,t.vz*=r,t.speed>5){const o=Math.floor(t.speed/2);for(let n=0;n<o;n++)this.speedLines.push({x:t.x+(Math.random()-.5)*300,y:t.y+(Math.random()-.5)*300,z:t.z+(Math.random()-.5)*300,vx:-t.vx*.5,vy:-t.vy*.5,life:1})}this.speedLines.forEach(o=>{o.x+=o.vx,o.y+=o.vy,o.life-=.05}),this.speedLines=this.speedLines.filter(o=>o.life>0),this.camera.x=-t.x*this.camera.zoom,this.camera.y=-t.y*this.camera.zoom,this.checkAndGenerateSectors()}loadInventory(){try{const t=localStorage.getItem("playerInventory");return t?JSON.parse(t):{}}catch(t){return console.error("Failed to load inventory:",t),{}}}saveInventory(){try{localStorage.setItem("playerInventory",JSON.stringify(this.playerInventory))}catch(t){console.error("Failed to save inventory:",t)}}loadCredits(){return parseInt(localStorage.getItem("playerCredits"))||0}saveCredits(){localStorage.setItem("playerCredits",this.credits)}loadUpgrades(){try{return JSON.parse(localStorage.getItem("playerUpgrades"))||{speed:0,armor:0,weapons:0,shield:0,cargo:0,radar:0}}catch{return{speed:0,armor:0,weapons:0,shield:0,cargo:0,radar:0}}}saveUpgrades(){localStorage.setItem("playerUpgrades",JSON.stringify(this.playerShip.upgrades))}sellAllGems(){console.log("[Sell All] Button clicked!");let t=0,e=0;for(const[i,a]of Object.entries(this.playerInventory))if(a>0){const l=this.mineralTypes[i].value;t+=l*a,e+=a,this.playerInventory[i]=0}t>0?(this.credits+=t,this.saveCredits(),this.saveInventory(),this.showToast(`Sold ${e} gems for $${t.toLocaleString()}`),console.log("[Sell All] Success:",e,"gems for $",t)):(this.showToast("No gems to sell"),console.log("[Sell All] No gems in inventory"))}upgradeShip(t){const e=[1e3,2500,5e3,1e4,25e3],i=this.playerShip.upgrades[t]||0;if(i>=5){this.showToast("Max level reached!");return}const a=e[i];if(this.credits>=a){this.credits-=a,this.playerShip.upgrades[t]++,this.saveCredits(),this.saveUpgrades();const l=this.playerShip.upgrades[t];t==="speed"?(this.playerShip.maxSpeed=50*(1+l*.2),this.playerShip.acceleration=.5*(1+l*.1)):t==="armor"?(this.playerShip.maxHull=100*(1+l*.2),this.playerShip.hullHealth=this.playerShip.maxHull):t==="shield"?(this.playerShip.maxShield=50*(1+l*.2),this.playerShip.shield=this.playerShip.maxShield):t==="radar"&&(this.playerShip.radarRange=2e3*(1+l*.3)),this.showToast(`${t.toUpperCase()} Upgraded to Level ${l+1}!`),this.updateUpgradeUI()}else this.showToast(`Not enough credits! Need $${a.toLocaleString()}`)}spawnMinerals(){const t=this.playerShip,e=1500;let i=200,a=1,l=null,r=!1;for(const n of this.resourceDeposits){const s=t.x-n.x,m=t.y-n.y;if(Math.sqrt(s*s+m*m)<n.radius){a=3,i=500,l=n,r=!0;break}}const o=Math.sqrt(t.x*t.x+t.y*t.y);for(this.minerals=this.minerals.filter(n=>{const s=n.x-t.x,m=n.y-t.y,c=n.z-t.z;return Math.sqrt(s*s+m*m+c*c)<e*3});this.minerals.length<i;){const n=this.getZoneAtDistance(o),s=this.selectElementForZone(n,o,a),m=this.mineralTypes[s];if(!m)continue;const c=Math.random()*Math.PI*2,h=e*Math.sqrt(Math.random()),d=(Math.random()-.5)*400;let g,f;if(r&&Math.random()<.6){const y=Math.random()*Math.PI*2,p=l.radius*Math.sqrt(Math.random())*.7;g=l.x+Math.cos(y)*p,f=l.y+Math.sin(y)*p}else g=t.x+Math.cos(c)*h,f=t.y+Math.sin(c)*h;const u=t.z+d;this.minerals.push({id:Date.now()+Math.random(),type:s,...m,x:g,y:f,z:u,phase:Math.random()*Math.PI*2,defended:m.rarity==="epic"||m.rarity==="legendary"||m.rarity==="mythic"})}}getZoneAtDistance(t){for(const[e,i]of Object.entries(this.galaxyZones))if(t>=i.distanceRange.min&&t<i.distanceRange.max)return e;return t>=5e3?"exotic":"industrial"}selectElementForZone(t,e,i=1){const a=this.galaxyZones,l=Object.keys(this.mineralTypes),r=[];let o=0;for(const s of l){const m=this.mineralTypes[s];let c=1;if(e<1500)switch(m.rarity){case"common":c=70;break;case"uncommon":c=25;break;case"rare":c=5;break;default:c=0;break}else if(e<3e3)switch(m.rarity){case"common":c=40;break;case"uncommon":c=40;break;case"rare":c=15;break;case"epic":c=5;break;default:c=0;break}else if(e<5e3)switch(m.rarity){case"common":c=0;break;case"uncommon":c=25;break;case"rare":c=35;break;case"epic":c=30;break;case"legendary":c=10;break;default:c=0;break}else switch(m.rarity){case"common":c=0;break;case"uncommon":c=0;break;case"rare":c=20;break;case"epic":c=40;break;case"legendary":c=30;break;case"mythic":c=10;break}i>1&&m.rarity!=="common"&&(c*=i),a[m.zone]&&a[m.zone].elements.includes(s)&&m.zone===t&&(c*=1.5),r.push({key:s,weight:c}),o+=c}let n=Math.random()*o;for(const{key:s,weight:m}of r)if(n-=m,n<=0)return s;return"iron"}collectMineral(t){const e=this.playerShip,i=t.x-e.x,a=t.y-e.y,l=t.z-e.z,r=Math.sqrt(i*i+a*a+l*l),o=e.size+t.size;if(r<o){this.playerInventory[t.type]||(this.playerInventory[t.type]=0),this.playerInventory[t.type]++,this.saveInventory(),this.collectionNotifications.push({text:`+${t.name} ($${t.value})`,color:t.color,time:Date.now()});const n=this.minerals.indexOf(t);n>-1&&this.minerals.splice(n,1)}}updateMinerals(){if(!this.flightMode)return;for(const e of[...this.minerals])this.collectMineral(e);this.spawnMinerals();const t=Date.now();this.collectionNotifications=this.collectionNotifications.filter(e=>t-e.time<2e3)}toggleMatrixRainbow(){this.matrixRainbowMode=!this.matrixRainbowMode;const t=document.getElementById("matrixRainbowBtn");t&&t.classList.toggle("active",this.matrixRainbowMode)}updateStarColors(){var t,e,i;try{const a=((t=document.getElementById("starColor1"))==null?void 0:t.value)||"#ffffff",l=((e=document.getElementById("starColor2"))==null?void 0:e.value)||"#aaddff",r=((i=document.getElementById("starColor3"))==null?void 0:i.value)||"#ffddaa";this.starColors=[a,l,r],this.generateStaticStars(),this.showToast("Star colors updated")}catch(a){console.error("[BG Error] updateStarColors failed:",a)}}toggleBgDrift(){try{if(this.bgWarpMode){this.bgWarpMode=!1;const e=document.getElementById("bgWarpBtn");e&&e.classList.remove("active")}this.bgDriftMode=!this.bgDriftMode;const t=document.getElementById("bgDriftBtn");t&&t.classList.toggle("active",this.bgDriftMode),this.generateStaticStars(),this.showToast(this.bgDriftMode?"Star Drift ON":"Star Drift OFF")}catch(t){console.error("[BG Error] toggleBgDrift failed:",t),this.bgDriftMode=!1,this.showToast("Drift mode error - please try again")}}toggleUpgradePanel(){const t=document.getElementById("upgradePanel");t&&(t.classList.toggle("hidden"),t.classList.contains("hidden")||this.updateUpgradeUI())}updateUpgradeUI(){const t=document.getElementById("upgradeList"),e=document.getElementById("dockCredits");if(!t||!e)return;e.textContent="$"+this.credits.toLocaleString();const i=[{id:"speed",name:"Engine Overclock",desc:"Increases max speed & acceleration"},{id:"armor",name:"Nanocarbon Hull",desc:"Increases hull integrity"},{id:"weapons",name:"Photon Cannons",desc:"Increases damage output (Coming Soon)"},{id:"shield",name:"Energy Shield",desc:"Increases shield capacity"},{id:"cargo",name:"Quantum Hold",desc:"Increases gem capacity (Coming Soon)"},{id:"radar",name:"Deep Scan Radar",desc:"Increases detection range"}],a=[1e3,2500,5e3,1e4,25e3];let l="";i.forEach(r=>{const o=this.playerShip.upgrades[r.id]||0,n=a[o],s=o>=5,m=this.credits>=n;let c="";for(let h=0;h<5;h++)c+=`<div style="flex:1; height:4px; background:${h<o?"#00f3ff":"rgba(255,255,255,0.1)"}; margin:0 1px;"></div>`;l+=`
                        <div style="background:rgba(255,255,255,0.05); border:1px solid ${m?"rgba(0,243,255,0.3)":"rgba(255,50,50,0.3)"}; padding:8px; border-radius:6px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span style="font-weight:bold; color:#e0faff; font-size:11px;">${r.name}</span>
                                <span style="font-size:10px; color:${s?"#00f3ff":"#ffd700"}">${s?"MAX":"$"+n.toLocaleString()}</span>
                            </div>
                            <div style="font-size:9px; color:#8ba; margin-bottom:6px;">${r.desc}</div>
                            <div style="display:flex; margin-bottom:6px;">${c}</div>
                            ${s?"":`<button class="btn-small" onclick="app.upgradeShip('${r.id}')" style="width:100%; font-size:10px; padding:4px; ${m?"cursor:pointer":"opacity:0.5; cursor:not-allowed;"}">UPGRADE</button>`}
                        </div>
                    `}),t.innerHTML=l}toggleBgWarp(){try{if(this.bgDriftMode){this.bgDriftMode=!1;const a=document.getElementById("bgDriftBtn");a&&a.classList.remove("active")}const t=document.getElementById("bgWarpBtn");if(this.warpDisengaging){this.showToast("Warp still decelerating...");return}if(this.bgWarpMode){this.warpDisengaging=!0,this.disengageStartTime=performance.now(),this.disengageDuration=4500,t&&t.classList.remove("active"),this.showToast("Warp Disengaged - Decelerating..."),this.warpSliderAnimation&&(cancelAnimationFrame(this.warpSliderAnimation),this.warpSliderAnimation=null);const a=document.getElementById("warpSpeedSlider");if(a){const l=parseFloat(a.value)||100,r=performance.now(),o=1500,n=3e3,s=o+n,m=c=>{if(!this.warpDisengaging)return;const h=c-r;let d;if(h<o){const g=h/o,f=1-Math.pow(1-g,2);d=l-l*.5*f}else if(h<s){const f=(h-o)/n,u=1-Math.pow(1-f,3);d=l*.5-l*.5*u}else{d=0,this.warpDisengaging=!1,this.bgWarpMode=!1;const g=f=>{f&&f.forEach(u=>{u.flownOut=!1,u.wasFlownOut=!1,u.disengageInit=!1,u.returning=!1,u.arrivalAngle=void 0,u.warpScale=void 0,u.warpAlpha=void 0,u.startWarpSpeed=void 0,u.startScreenX=void 0,u.startScreenY=void 0,u.finalX=void 0,u.finalY=void 0,u.disengageFinalX=void 0,u.disengageFinalY=void 0,u.targetX=void 0,u.targetY=void 0,u.origX=void 0,u.origY=void 0,u.typeIndex=void 0})};g(this.planets),g(this.galaxies),g(this.blackHoles),g(this.nebulae),g(this.spacecraft),g(this.stars),a.value=0,this.setWarpSpeedMultiplier(0),this.showToast("Arrived at new destination");return}a.value=Math.max(0,d),this.setWarpSpeedMultiplier(Math.max(0,d),!1),this.warpSliderAnimation=requestAnimationFrame(m)};this.warpSliderAnimation=requestAnimationFrame(m)}return}this.bgWarpMode=!0,this.warpDisengaging=!1,t&&t.classList.add("active"),this.warpSpeed=0,this.showToast("WARP ENGAGED!");const e=a=>{a&&(a.origX=a.x,a.origY=a.y,a.flownOut=!1,a.returning=!1)};this.planets&&this.planets.forEach(e),this.galaxies&&this.galaxies.forEach(e),this.blackHoles&&this.blackHoles.forEach(e),this.nebulae&&this.nebulae.forEach(e),this.spacecraft&&this.spacecraft.forEach(e),this.stars&&this.stars.forEach(e);const i=document.getElementById("warpSpeedSlider");if(i){this.warpSliderAnimation&&cancelAnimationFrame(this.warpSliderAnimation),this.warpManualControl=!1;const a=()=>{this.warpManualControl=!0,this.warpSliderAnimation&&(cancelAnimationFrame(this.warpSliderAnimation),this.warpSliderAnimation=null)};i.removeEventListener("mousedown",a),i.removeEventListener("touchstart",a),i.removeEventListener("pointerdown",a),i.addEventListener("mousedown",a),i.addEventListener("touchstart",a),i.addEventListener("pointerdown",a),i.value=1,this.setWarpSpeedMultiplier(1);const l=performance.now(),r=3e3,o=1500,n=r+o,s=m=>{if(!this.bgWarpMode||this.warpManualControl||this.warpDisengaging)return;const c=m-l;let h;if(c<r)h=1+c/r*49.5;else if(c<n){const d=c-r;h=50.5+Math.min(1,d/o)*49.5}else{const d=(c-n)/1e3,g=Math.sin(d*.8)*5,f=Math.sin(d*2.3)*3,u=Math.sin(d*5.7)*2,y=Math.sin(d*.3)*Math.sin(d*1.1)*4;h=92+(g+f+u+y),h=Math.max(85,Math.min(100,h))}i.value=h,this.setWarpSpeedMultiplier(h),this.warpSliderAnimation=requestAnimationFrame(s)};this.warpSliderAnimation=requestAnimationFrame(s)}}catch(t){console.error("[BG Error] toggleBgWarp failed:",t),this.bgWarpMode=!1,this.warpDisengaging=!1,this.showToast("Warp mode error - please try again")}}setWarpSpeedMultiplier(t,e=!0){const i=parseFloat(t)||0;if(e)if(i>.5){this.bgWarpMode||(this.bgWarpMode=!0),this.warpDisengaging=!1;const r=document.getElementById("bgWarpBtn");r&&r.classList.add("active")}else if(i===0){this.bgWarpMode=!1,this.warpDisengaging=!1,this.warpSpeed=0;const r=document.getElementById("bgWarpBtn");r&&r.classList.remove("active"),this.showToast("Engines Stopped")}else this.bgWarpMode&&!this.warpDisengaging&&(this.warpDisengaging=!0);const a=i/100,l=Math.pow(a,3);this.warpSpeedMultiplier=l*840,this.warpSliderRaw=i}updateColorModeUI(){const t=document.getElementById("fixedModeIndicator"),e=document.getElementById("rainbowBtn"),i=document.getElementById("currentColorModeText"),a=document.getElementById("colorInput");a&&(a.value=this.activeColor),this.colorMode==="fixed"?(t&&(t.classList.add("active"),t.style.background=this.activeColor),e&&e.classList.remove("active"),i&&(i.innerText=`Color Mode: Fixed (${this.activeColor})`)):(t&&t.classList.remove("active"),e&&e.classList.add("active"),i&&(i.innerText="Color Mode: Rainbow (Random per star)"))}getWorldPos(t){return{x:(t.clientX-this.canvas.width/2-this.camera.x)/this.camera.zoom,y:(t.clientY-this.canvas.height/2-this.camera.y)/this.camera.zoom}}onPointerDown(t){if(this.pointer.button=t.button,this.pointer.onCanvas=t.target===this.canvas,this.pointer.isDown=!0,this.pointer.startX=t.clientX,this.pointer.startY=t.clientY,this.pointer.camStartX=this.camera.x,this.pointer.camStartY=this.camera.y,this.pointer.rotStartX=this.rotationX,this.pointer.rotStartY=this.rotationY,this.pointer.orbitMode=t.button===1||t.button===0&&t.altKey,this.pointer.panMode=t.button===0&&t.shiftKey,this.pointer.orbitMode||this.pointer.panMode)return;const e=this.getWorldPos(t),i=this.config.starBaseRad*4/this.camera.zoom,a=this.stars.find(l=>Math.hypot(l.x-e.x,l.y-e.y)<i);if(a){if(this.refreshClusterAssignments(),this.mode==="select"&&a.clusterId){this.draggedClusterId=String(a.clusterId),this.pointer.lastWorldX=e.x,this.pointer.lastWorldY=e.y,this.saveState();return}this.mode==="draw"&&(this.draggedStar=a,this.saveState())}}onPointerMove(t){const e=this.getWorldPos(t),i=this.config.starBaseRad*4/this.camera.zoom;this.hoveredStar=this.stars.find(n=>Math.hypot(n.x-e.x,n.y-e.y)<i);let a="default";if(this.pointer.orbitMode&&this.pointer.isDown?a="grab":this.pointer.panMode&&this.pointer.isDown?a="move":this.draggedStar||this.draggedClusterId||this.pointer.dragging?a="grabbing":this.hoveredStar?a="move":this.mode==="draw"&&(a="crosshair"),this.canvas.style.cursor=a,!this.pointer.isDown)return;const l=t.clientX-this.pointer.startX,r=t.clientY-this.pointer.startY;if(Math.hypot(l,r)>5&&(this.pointer.dragging=!0),this.pointer.orbitMode){this.rotationY=this.pointer.rotStartY+l*.5,this.rotationX=this.pointer.rotStartX+r*.5,this.draw();const n=document.getElementById("rotXSlider"),s=document.getElementById("rotYSlider");n&&(n.value=this.rotationX%360,document.getElementById("rotXValue").textContent=Math.round(this.rotationX%360)+"Â°"),s&&(s.value=this.rotationY%360,document.getElementById("rotYValue").textContent=Math.round(this.rotationY%360)+"Â°");return}if(this.pointer.panMode){this.camera.x=this.pointer.camStartX+l,this.camera.y=this.pointer.camStartY+r;return}if(this.draggedClusterId){const n=e.x-this.pointer.lastWorldX,s=e.y-this.pointer.lastWorldY,m=this.draggedClusterId;this.stars.forEach(c=>{String(c.clusterId)===m&&(c.x+=n,c.y+=s)}),this.pointer.lastWorldX=e.x,this.pointer.lastWorldY=e.y;return}if(this.draggedStar){this.draggedStar.x=e.x,this.draggedStar.y=e.y;return}if(this.pointer.dragging){this.rotationY=this.pointer.rotStartY+l*.5,this.rotationX=this.pointer.rotStartX+r*.5,this.draw();const n=document.getElementById("rotXSlider"),s=document.getElementById("rotYSlider");n&&(n.value=this.rotationX%360,document.getElementById("rotXValue").textContent=Math.round(this.rotationX%360)+"Â°"),s&&(s.value=this.rotationY%360,document.getElementById("rotYValue").textContent=Math.round(this.rotationY%360)+"Â°")}}onPointerUp(t){const e=this.pointer.orbitMode||this.pointer.panMode;if(this.pointer.onCanvas&&!e){const i=this.getWorldPos(t),a=this.config.starBaseRad*4/this.camera.zoom,l=this.stars.find(r=>Math.hypot(r.x-i.x,r.y-i.y)<a);if(!this.pointer.dragging&&!l&&this.mode==="draw"){this.saveState();const r=this.getConstellationCenter();this._cachedRotationCenter={x:r.x,y:r.y,z:r.z};const o=this.inverseRotate3D(i.x,i.y,r.x,r.y);this.createStar(o.x,o.y,o.z),setTimeout(()=>{this._cachedRotationCenter=null},100)}}this.pointer.isDown=!1,this.pointer.dragging=!1,this.pointer.onCanvas=!1,this.pointer.orbitMode=!1,this.pointer.panMode=!1,this.pointer.button=0,this.draggedStar=null,this.draggedClusterId=null}onRightClick(t){t.preventDefault();const e=this.getWorldPos(t),i=this.config.starBaseRad*4/this.camera.zoom,a=this.stars.findIndex(r=>Math.hypot(r.x-e.x,r.y-e.y)<i);if(a!==-1){this.saveState(),this.stars.splice(a,1),this.showToast("Deleted star"),this.draw();return}const l=5/this.camera.zoom;for(let r=0;r<this.stars.length;r++){const o=this.stars[r];for(let n=r+1;n<this.stars.length;n++){const s=this.stars[n];if(Math.hypot(o.x-s.x,o.y-s.y)>this.config.maxConnectDist)continue;const m=Math.hypot(s.x-o.x,s.y-o.y);if(m===0)continue;const c=Math.max(0,Math.min(1,((e.x-o.x)*(s.x-o.x)+(e.y-o.y)*(s.y-o.y))/(m*m))),h=o.x+c*(s.x-o.x),d=o.y+c*(s.y-o.y);if(Math.hypot(e.x-h,e.y-d)<l){this.saveState();const f=[r,n].sort((u,y)=>y-u);this.stars.splice(f[0],1),this.stars.splice(f[1],1),this.showToast("Deleted connection"),this.draw();return}}}}onWheel(t){t.preventDefault();const i=Math.max(.1,Math.min(6,this.camera.zoom-t.deltaY*.0015)),a=this.getWorldPos(t);this.camera.zoom=i,this.camera.x=t.clientX-this.canvas.width/2-a.x*this.camera.zoom,this.camera.y=t.clientY-this.canvas.height/2-a.y*this.camera.zoom}createStar(t,e,i=0){let a=this.activeColor;this.colorMode==="rainbow"&&(a=this.getRainbowHex()),this.stars.push({x:t,y:e,z:i,id:Math.floor(Date.now()+Math.random()*1e3).toString(),phase:Math.random()*Math.PI*2,color:a,clusterId:null}),this.draw()}refreshClusterAssignments(){const{lines:t,clusters:e}=this.calculateGeometry(),i=new Map;return e.forEach(a=>{if(a.length>=this.config.minGroupSize){const l=this.getConstellationName(a);a.forEach(r=>{i.set(r.id,l)})}}),this.stars.forEach(a=>{const l=i.get(a.id);l?a.clusterId=l:a.clusterId&&isNaN(parseFloat(a.clusterId))||(a.clusterId=a.id)}),{lines:t,clusters:e}}getStarColor(t){return t.color||"#e0faff"}hexToRgb(t){const e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(e,(a,l,r,o)=>l+l+r+r+o+o);const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?[parseInt(i[1],16),parseInt(i[2],16),parseInt(i[3],16)]:[224,240,255]}saveState(){const t=JSON.stringify(this.stars.map(e=>({x:e.x,y:e.y,id:String(e.id),phase:e.phase,color:e.color})));this.history.length>25&&this.history.shift(),this.history.push(t),console.log("[UNDO] saveState called, history length:",this.history.length)}undo(){if(console.log("[UNDO] undo() called, history length:",this.history.length),this.history.length===0){this.showToast("Nothing to undo");return}const t=this.history.pop();t?(this.stars=JSON.parse(t),console.log("[UNDO] Restored state with",this.stars.length,"stars")):this.stars=[],this.draw(),this.showToast(`Undone (${this.history.length} remaining)`)}requestClear(){document.getElementById("clearModal").classList.add("active")}closeModal(){document.getElementById("clearModal").classList.remove("active")}confirmClear(){this.saveState(),this.stars=[],this.camera={x:0,y:0,zoom:1},this.closeModal(),this.draw(),this.showToast("Universe Imploded")}resetView(){this.camera={x:0,y:0,zoom:1}}adjustZoom(t){this.camera.zoom=Math.max(.1,Math.min(6,this.camera.zoom+t)),this.flightMode&&this.playerShip&&(this.camera.x=-this.playerShip.x*this.camera.zoom,this.camera.y=-this.playerShip.y*this.camera.zoom)}getConstellationName(t){const e=t.find(s=>s.clusterId&&isNaN(parseFloat(s.clusterId)));if(e)return e.clusterId;const i=t.map(s=>String(s.id)).sort((s,m)=>s.localeCompare(m));let a=0;i.forEach((s,m)=>{for(let c=0;c<s.length;c++)a+=s.charCodeAt(c)*(c+1)*(m+1)}),a=Math.floor(a);const l=this.prefixes[a%this.prefixes.length],r=this.roots[a*13%this.roots.length],o=this.suffixes[a*7%this.suffixes.length],n=a%3;return n===0?`${l} ${r}`:n===1?`${r} ${o}`:`The ${l} ${r} ${o}`}generateBackground(){try{this.config.showBackground=!0,this.staticStars=[],this.galaxies=[],this.blackHoles=[],this.shootingStars=[],this.backgroundStars=[],this.nebulae=[],this.spacecraft=[],this.matrixStreams=[];try{const t=localStorage.getItem("matrixThemeHistory");this.themeHistory=t?JSON.parse(t):[],this.lastMatrixFamily=localStorage.getItem("matrixLastFamily")||""}catch(t){console.warn("[BG] Theme history load failed:",t),this.themeHistory=[],this.lastMatrixFamily=""}try{this.generateStaticStars()}catch(t){console.error("[BG Error] generateStaticStars failed:",t),this.staticStars=[]}if(this.activeStyles.has("deep-space"))try{this.generateDeepSpaceStyle()}catch(t){console.error("[BG Error] generateDeepSpaceStyle failed:",t)}if(this.activeStyles.has("nebula"))try{this.generateNebulaStyle()}catch(t){console.error("[BG Error] generateNebulaStyle failed:",t)}if(this.activeStyles.has("alien"))try{this.generateAlienStyle()}catch(t){console.error("[BG Error] generateAlienStyle failed:",t)}if(this.activeStyles.has("cyber"))try{this.generateCyberStyle()}catch(t){console.error("[BG Error] generateCyberStyle failed:",t)}}catch(t){console.error("[BG Error] generateBackground failed critically:",t),this.showToast("Background generation failed - using minimal mode"),this.staticStars=this.staticStars||[],this.galaxies=this.galaxies||[],this.blackHoles=this.blackHoles||[],this.shootingStars=this.shootingStars||[],this.backgroundStars=this.backgroundStars||[],this.nebulae=this.nebulae||[],this.spacecraft=this.spacecraft||[],this.matrixStreams=this.matrixStreams||[]}}generateStaticStars(){var h,d,g;this.staticStars=[];const t=this.bgWarpMode?600:400,e=((h=document.getElementById("starColor1"))==null?void 0:h.value)||"#ffffff",i=((d=document.getElementById("starColor2"))==null?void 0:d.value)||"#aaddff",a=((g=document.getElementById("starColor3"))==null?void 0:g.value)||"#ffddaa",l=[e,i,a];this.starColors=l;const r=this.canvas.width,o=this.canvas.height,n=r/2,s=o/2,m=r*20,c=o*20;for(let f=0;f<t;f++){let u,y,p=0,v=0;if(this.bgWarpMode){const S=Math.random()*Math.PI*2,x=Math.random()*Math.max(r,o)*.8;u=n+Math.cos(S)*x,y=s+Math.sin(S)*x;const b=4+Math.random()*16;p=Math.cos(S)*b,v=Math.sin(S)*b}else if(u=Math.random()*m-m/2+n,y=Math.random()*c-c/2+s,this.bgDriftMode){const S=Math.random()*Math.PI*2,x=.1+Math.random()*.3;p=Math.cos(S)*x,v=Math.sin(S)*x}const w=.3+Math.random()*.7;this.staticStars.push({x:u,y,vx:p,vy:v,size:(Math.random()*1.5+.5)*w,alpha:Math.random()*.5+.1,baseAlpha:Math.random()*.5+.1,color:l[Math.floor(Math.random()*l.length)],depth:w})}}getHueFromHex(t){const e=this.hexToRgb(t),i=e[0]/255,a=e[1]/255,l=e[2]/255,r=Math.max(i,a,l),o=Math.min(i,a,l);let n=0;if(r!==o){const s=r-o;r===i?n=((a-l)/s+(a<l?6:0))/6:r===a?n=((l-i)/s+2)/6:n=((i-a)/s+4)/6}return Math.round(n*360)}hslToHex(t,e,i){e/=100,i/=100;const a=n=>(n+t/30)%12,l=e*Math.min(i,1-i),r=n=>i-l*Math.max(-1,Math.min(a(n)-3,Math.min(9-a(n),1))),o=n=>Math.round(n*255).toString(16).padStart(2,"0");return`#${o(r(0))}${o(r(8))}${o(r(4))}`}generateDeepSpaceStyle(){this.worldSize;const t=3e3,e=600;for(let h=0;h<e;h++){const d=Math.random();let g,f;d<.2?(g=Math.random()*400,f=.5+Math.random()*1):d<.5?(g=400+Math.random()*1600,f=1+Math.random()*1.5):(g=2e3+Math.random()*4e3,f=1.5+Math.random()*2);const u=Math.random()*Math.PI*2;this.backgroundStars.push({x:Math.cos(u)*g,y:Math.sin(u)*g,z:Math.random()*t-t/2,r:f,alpha:.15+Math.random()*.5})}[{count:2,minDist:100,maxDist:400,minSize:60,maxSize:120},{count:4,minDist:400,maxDist:2e3,minSize:100,maxSize:250},{count:6,minDist:2e3,maxDist:6e3,minSize:200,maxSize:450}].forEach(h=>{for(let d=0;d<h.count;d++){const g=h.minDist+Math.random()*(h.maxDist-h.minDist),f=Math.random()*Math.PI*2;this.galaxies.push({x:Math.cos(f)*g,y:Math.sin(f)*g,z:Math.random()*t-t/2,color:["#ff0055","#5500ff","#00aaff","#ff00aa","#00ff88","#ffaa00","#aa00ff","#ffffff"][Math.floor(Math.random()*8)],angle:Math.random()*Math.PI*2,size:h.minSize+Math.random()*(h.maxSize-h.minSize)})}}),[{minDist:200,maxDist:500,minSize:20,maxSize:40},{minDist:800,maxDist:2e3,minSize:40,maxSize:80},{minDist:2500,maxDist:5e3,minSize:80,maxSize:150}].forEach(h=>{const d=h.minDist+Math.random()*(h.maxDist-h.minDist),g=Math.random()*Math.PI*2;this.blackHoles.push({x:Math.cos(g)*d,y:Math.sin(g)*d,z:Math.random()*t-t/2,size:h.minSize+Math.random()*(h.maxSize-h.minSize)})}),[{count:4,minDist:50,maxDist:500,minSize:150,maxSize:350},{count:6,minDist:500,maxDist:2500,minSize:350,maxSize:700},{count:8,minDist:2500,maxDist:6e3,minSize:600,maxSize:1200}].forEach(h=>{for(let d=0;d<h.count;d++){const g=h.minDist+Math.random()*(h.maxDist-h.minDist),f=Math.random()*Math.PI*2;this.nebulae.push({x:Math.cos(f)*g,y:Math.sin(f)*g,z:Math.random()*t-t/2,size:h.minSize+Math.random()*(h.maxSize-h.minSize),color:["#4400cc","#0033aa","#cc0066","#330066","#003366","#660033"][Math.floor(Math.random()*6)],alpha:.15+Math.random()*.3})}}),this.planets=[];const r=[{name:"gas-giant",colors:["#E8C273","#C17B3A","#8B5A2B"],hasAtmosphere:!0},{name:"ice-giant",colors:["#87CEEB","#4682B4","#5F9EA0"],hasAtmosphere:!0},{name:"terrestrial",colors:["#228B22","#8B4513","#2E8B57"],hasAtmosphere:!0},{name:"desert",colors:["#EDC9AF","#D2691E","#CD853F"],hasAtmosphere:!1},{name:"volcanic",colors:["#8B0000","#FF4500","#DC143C"],hasAtmosphere:!0},{name:"ocean",colors:["#0077BE","#005A87","#003F5C"],hasAtmosphere:!0}],o=[{count:3,minDist:100,maxDist:500,minRadius:20,maxRadius:50},{count:5,minDist:500,maxDist:2500,minRadius:40,maxRadius:100},{count:7,minDist:2500,maxDist:6e3,minRadius:80,maxRadius:180}],n=(h,d=30)=>{if(!h||!h.startsWith("#"))return h;let g=parseInt(h.slice(1,3),16),f=parseInt(h.slice(3,5),16),u=parseInt(h.slice(5,7),16);return g=Math.min(255,Math.max(0,g+(Math.random()-.5)*d*2)),f=Math.min(255,Math.max(0,f+(Math.random()-.5)*d*2)),u=Math.min(255,Math.max(0,u+(Math.random()-.5)*d*2)),`#${(g|0).toString(16).padStart(2,"0")}${(f|0).toString(16).padStart(2,"0")}${(u|0).toString(16).padStart(2,"0")}`},s=(h,d,g,f)=>{for(const p of this.planets){const v=h-p.x,w=d-p.y,S=g-p.z,x=Math.sqrt(v*v+w*w),b=f+p.radius+800;if(x<b&&Math.abs(S)<1e3)return!1}return!0},m=[{minZ:-1e3,maxZ:-400},{minZ:-400,maxZ:400},{minZ:400,maxZ:1200}];o.forEach((h,d)=>{const g=m[d];for(let f=0;f<h.count;f++){const u=r[Math.floor(Math.random()*r.length)],y=Math.random()>.5,p=h.minRadius+Math.random()*(h.maxRadius-h.minRadius);let v,w,S,x=0;do{const b=h.minDist+Math.random()*(h.maxDist-h.minDist),M=Math.random()*Math.PI*2;v=Math.cos(M)*b,w=Math.sin(M)*b,S=g.minZ+Math.random()*(g.maxZ-g.minZ),x++}while(!s(v,w,S,p)&&x<50);this.planets.push({x:v,y:w,z:S,radius:p,type:u.name,baseColor:n(u.colors[0],40),secondaryColor:n(u.colors[1],40),tertiaryColor:n(u.colors[2],40),hasAtmosphere:u.hasAtmosphere,atmosphereColor:u.name==="ice-giant"?"#ADD8E6":u.name==="volcanic"?"#FF6347":"#87CEEB",hasRings:y,ringColor:y?`hsl(${Math.random()*360}, ${40+Math.random()*40}%, ${50+Math.random()*30}%)`:null,ringInnerRadius:p*1.3,ringOuterRadius:p*2.2,textureSeed:Math.random()*1e3,rotation:Math.random()*Math.PI*2,axialTilt:(Math.random()-.5)*.6})}}),this.shootingStars=[];const c=15;for(let h=0;h<c;h++){const d=Math.random()*Math.PI*2,g=500+Math.random()*5e3;this.shootingStars.push({x:Math.cos(d)*g,y:Math.sin(d)*g,z:Math.random()*t-t/2,vx:(Math.random()-.5)*2,vy:(Math.random()-.5)*2,size:1+Math.random()*2,tailLength:20+Math.random()*40,color:["#ffffff","#ffffaa","#aaffff","#ffaaff"][Math.floor(Math.random()*4)],alpha:.4+Math.random()*.4})}}generateNebulaStyle(){const e=[{count:6,minDist:50,maxDist:500,minSize:100,maxSize:300},{count:10,minDist:500,maxDist:2500,minSize:300,maxSize:800},{count:14,minDist:2500,maxDist:6e3,minSize:700,maxSize:1500}],i=["#ff0055","#ffaa00","#00ffaa","#0055ff","#ff00ff","#00ffff","#ff5500","#55ff00"];e.forEach(l=>{for(let r=0;r<l.count;r++){const o=l.minDist+Math.random()*(l.maxDist-l.minDist),n=Math.random()*Math.PI*2;this.nebulae.push({x:Math.cos(n)*o,y:Math.sin(n)*o,z:Math.random()*3e3-3e3/2,size:l.minSize+Math.random()*(l.maxSize-l.minSize),color:i[Math.floor(Math.random()*i.length)],alpha:.25+Math.random()*.35})}});const a=1e3;for(let l=0;l<a;l++){const r=Math.random();let o,n;r<.2?(o=Math.random()*500,n=.5+Math.random()*1):r<.5?(o=500+Math.random()*2e3,n=1+Math.random()*1.5):(o=2500+Math.random()*3500,n=1.5+Math.random()*2.5);const s=Math.random()*Math.PI*2;this.backgroundStars.push({x:Math.cos(s)*o,y:Math.sin(s)*o,z:Math.random()*3e3-3e3/2,r:n,alpha:.2+Math.random()*.5})}}generateAlienStyle(){const e=Math.random();let i,a;e<.33?(i="#00ff00",a="#ccff00"):e<.66?(i="#aa00ff",a="#ff00aa"):(i="#00ffff",a="#0000ff");const l=1800;for(let s=0;s<l;s++){const m=Math.random();let c,h;m<.2?(c=Math.random()*500,h=.3+Math.random()*.6):m<.5?(c=500+Math.random()*2e3,h=.5+Math.random()*.8):(c=2500+Math.random()*3500,h=.7+Math.random()*1.2);const d=Math.random()*Math.PI*2;this.backgroundStars.push({x:Math.cos(d)*c,y:Math.sin(d)*c,z:Math.random()*3e3-3e3/2,r:h,alpha:.1+Math.random()*.4,color:Math.random()>.5?i:a})}const r=[{name:"saucer",baseSize:50,complexity:"high",weight:4},{name:"star-dreadnought",baseSize:120,complexity:"high",weight:1},{name:"quantum-scout",baseSize:40,complexity:"high",weight:3},{name:"void-fighter",baseSize:30,complexity:"medium",weight:4},{name:"nebula-cruiser",baseSize:90,complexity:"high",weight:2},{name:"bio-corvette",baseSize:60,complexity:"high",weight:2},{name:"warp-strider",baseSize:100,complexity:"medium",weight:1},{name:"prism-destroyer",baseSize:80,complexity:"low",weight:2},{name:"stellar-barge",baseSize:110,complexity:"medium",weight:2},{name:"cyber-sentry",baseSize:35,complexity:"high",weight:3},{name:"aether-wing",baseSize:50,complexity:"high",weight:2},{name:"death-sphere",baseSize:150,complexity:"high",weight:1},{name:"tie-fighter",baseSize:45,complexity:"high",weight:3}],o=[];r.forEach(s=>{for(let m=0;m<s.weight;m++)o.push(s)}),[{count:6,minDist:50,maxDist:500,sizeScale:.4},{count:10,minDist:500,maxDist:2500,sizeScale:.7},{count:14,minDist:2500,maxDist:6e3,sizeScale:1.2}].forEach(s=>{for(let m=0;m<s.count;m++){const c=o[Math.floor(Math.random()*o.length)],h=Math.random()*360,d=c.baseSize*s.sizeScale*(.7+Math.random()*.6),g=c.name==="saucer",f=s.minDist+Math.random()*(s.maxDist-s.minDist),u=Math.random()*Math.PI*2;this.spacecraft.push({x:Math.cos(u)*f,y:Math.sin(u)*f,z:Math.random()*3e3-3e3/2,vx:(Math.random()-.5)*(g?2:3),vy:(Math.random()-.5)*(g?2:3),size:d,shipClass:c.name,complexity:c.complexity,hullColor:g?`hsl(${h}, 10%, 50%)`:`hsl(${h}, 30%, 40%)`,hullHighlight:g?`hsl(${h}, 5%, 85%)`:`hsl(${h}, 20%, 70%)`,hullShadow:g?`hsl(${h}, 15%, 25%)`:`hsl(${h}, 40%, 20%)`,engineColor:`hsl(${(h+180)%360}, 100%, 60%)`,engineGlow:`hsl(${(h+180)%360}, 100%, 85%)`,lightColor:`hsl(${Math.random()*60+300}, 100%, 55%)`,lightColor2:`hsl(${Math.random()*60}, 100%, 50%)`,lightPhase:Math.random()*Math.PI*2,detailSeed:Math.random()*1e3,wingAngle:.3+Math.random()*.4,engineCount:c.name==="mothership"?6:c.name==="destroyer"?4:c.name==="cruiser"?3:2,domeColor:`hsl(${Math.random()*180+160}, 80%, 70%)`,beamActive:Math.random()>.7,beamColor:`hsl(${Math.random()*60+80}, 100%, 70%)`,ringCount:g?Math.floor(Math.random()*3)+2:0,rotationSpeed:(Math.random()-.5)*.02,rotation:Math.random()*Math.PI*2,hasShield:Math.random()>.8,shieldColor:`hsl(${Math.random()*60+180}, 70%, 60%)`,shieldPhase:Math.random()*Math.PI*2})}})}generateCyberStyle(){this.matrixColorCustomized=!1,this.matrixStreams=[];const t=14,e=Math.ceil(this.canvas.width/t),i=[{name:"System Yellow",color:"#FFFF00",family:"yellow"},{name:"Neon Pink",color:"#FF1493",family:"pink"},{name:"Chrome Static",color:"#C0C0C0",family:"mono"},{name:"Royal Data",color:"#4169E1",family:"blue"},{name:"Navy Blue",color:"#000080",family:"blue"},{name:"White Noise",color:"#FFFFFF",family:"mono"},{name:"Golden Key",color:"#FFD700",family:"yellow"},{name:"Firewall Orange",color:"#FF4500",family:"pink"},{name:"Cyan Future",color:"#00FFFF",family:"blue"},{name:"Lime Access",color:"#32CD32",family:"green"},{name:"Purple Haze",color:"#800080",family:"purple"},{name:"Crimson Error",color:"#DC143C",family:"pink"},{name:"Teal Glitch",color:"#008080",family:"green"},{name:"Magenta Core",color:"#FF00FF",family:"pink"},{name:"Violet Mainframe",color:"#EE82EE",family:"purple"},{name:"Emerald Link",color:"#50C878",family:"green"},{name:"Sapphire Stream",color:"#0F52BA",family:"blue"},{name:"Ruby Firewall",color:"#E0115F",family:"pink"},{name:"Amber Alert",color:"#FFBF00",family:"yellow"},{name:"Ice Blue",color:"#A5F2F3",family:"blue"},{name:"sentAIent Blue",color:"#60A9FF",family:"blue"},{name:"Rainbow Surge",color:"rainbow",family:"rainbow"}],a=this.lastMatrixFamily||"";let l=i.filter(f=>!this.themeHistory.includes(f.name));const r=l.filter(f=>f.family!==a);r.length>0&&(l=r);let o=l;if(o.length===0){const f=this.themeHistory[this.themeHistory.length-1];o=i.filter(u=>u.name!==f)}const n=Math.floor(Math.random()*o.length),s=o[n];this.themeHistory.push(s.name),this.themeHistory.length>5&&this.themeHistory.shift(),this.lastMatrixFamily=s.family;try{localStorage.setItem("matrixThemeHistory",JSON.stringify(this.themeHistory)),localStorage.setItem("matrixLastFamily",this.lastMatrixFamily)}catch(f){console.warn("LocalStorage failed",f)}console.log(`[Matrix] Selected: ${s.name} (${s.family}), History: ${JSON.stringify(this.themeHistory)}, Pool Size: ${o.length}`),this.matrixTheme=s;const m=[{name:"Crawl",value:.2},{name:"Slow",value:.5},{name:"Normal",value:1},{name:"Fast",value:2},{name:"Hyper",value:4},{name:"Ludicrous",value:8}],c=m[Math.floor(Math.random()*m.length)];this.matrixSpeedMultiplier=c.value,this.showToast(`Cyber Theme: ${s.name} (Speed: ${c.name}) [v14]`);const h=document.getElementById("matrixThemeDisplay");h&&(h.innerText=`Theme: ${s.name} | Family: ${s.family.charAt(0).toUpperCase()+s.family.slice(1)}`);const d=document.getElementById("matrixSpeedSlider"),g=document.getElementById("matrixSpeedValue");d&&(d.value=this.matrixSpeedMultiplier),g&&(g.textContent=this.matrixSpeedMultiplier.toFixed(1)+"x");for(let f=0;f<e;f++){const u=Math.random(),y=Math.floor(10+u*14);(2+u*8+Math.random()*2)*this.matrixSpeedMultiplier;const p=600+Math.floor(Math.random()*9e3),v=[];for(let S=0;S<p;S++)v.push(String.fromCharCode(12448+Math.random()*96));let w=s.color;this.matrixColorCustomized?w=this.matrixColor:s.name==="Rainbow Surge"&&(w=`hsl(${f*360/e%360}, 100%, 50%)`),this.matrixStreams.push({x:f*t,y:-Math.random()*this.canvas.height-y*p,baseSpeed:2+u*8+Math.random()*2,chars:v,color:w,size:y,opacity:.3+u*.7})}console.log(`[Matrix] Generated ${this.matrixStreams.length} streams, columns: ${e}, theme: ${s.name}`)}animate(t){if(this.flightMode&&(this.updatePlayerShip(),this.updateMinerals(),this.updateFlightHUD()),this.spacecraft&&this.spacecraft.length>0){const i=this.worldSize/2;this.spacecraft.forEach(a=>{a.x+=a.vx,a.y+=a.vy,a.x>i&&(a.x=-i),a.x<-i&&(a.x=i),a.y>i&&(a.y=-i),a.y<-i&&(a.y=i)})}if(this.shootingStars&&this.shootingStars.length>0){const i=this.worldSize/2;this.shootingStars.forEach(a=>{a.x+=a.vx,a.y+=a.vy,a.x>i&&(a.x=-i),a.x<-i&&(a.x=i),a.y>i&&(a.y=-i),a.y<-i&&(a.y=i)})}try{if((this.bgDriftMode||this.bgWarpMode)&&this.staticStars&&this.staticStars.length>0){const e=this.canvas.width,i=this.canvas.height,a=e/2,l=i/2;if(this.bgWarpMode||this.warpDisengaging){const r=this.warpSpeedMultiplier||1,o=Math.min(25.2,r/33),n=.02;this.warpSpeed=this.warpSpeed||0,this.warpSpeed+=(o-this.warpSpeed)*n,this.warpSpeed=Math.min(this.warpSpeed,25.2),this.warpSpeed<.01&&(this.warpSpeed=0)}this.staticStars.forEach(r=>{if(typeof r.vx!="number"&&(r.vx=0),typeof r.vy!="number"&&(r.vy=0),typeof r.baseAlpha!="number"&&(r.baseAlpha=r.alpha||.5),typeof r.origX!="number"&&(r.origX=r.x),typeof r.origY!="number"&&(r.origY=r.y),(this.bgWarpMode||this.warpDisengaging)&&!this.bgDriftMode){const o=r.x-a,n=r.y-l,s=Math.sqrt(o*o+n*n),m=this.warpSpeed||0,c=Math.min(.08,m*.003),h=(Math.random()-.5)*c,d=s>1?o/s:0,g=s>1?n/s:0,f=Math.cos(h),u=Math.sin(h),y=d*f-g*u,p=d*u+g*f,v=r.depth||.5,w=1+s/Math.max(e,i)*1.2,S=m*w*10.5*v;r.x+=y*S,r.y+=p*S;const x=Math.max(e,i)*.9;if(s>x||r.x<-50||r.x>e+50||r.y<-50||r.y>i+50){const b=Math.random()*Math.PI*2,M=3+Math.random()*Math.random()*80;r.x=a+Math.cos(b)*M,r.y=l+Math.sin(b)*M,r.alpha=.05,r.depth=.3+Math.random()*.7,r.size=(Math.random()*1.5+.5)*r.depth}else{const b=.6+v*.4;r.alpha=Math.min(1,.15+s/x*.85*b)}}else this.bgDriftMode&&!this.bgWarpMode&&(r.x+=r.vx*.03,r.y+=r.vy*.03,r.x<-e*5&&(r.x+=e*10),r.x>e*5&&(r.x-=e*10),r.y<-i*5&&(r.y+=i*10),r.y>i*5&&(r.y-=i*10))})}}catch(e){console.error("[BG Error] Static star animation failed:",e)}if(this.bgWarpMode||this.warpDisengaging)try{const e=this.canvas.width,i=this.canvas.height,a=this.camera||{x:0,y:0,zoom:1},l=a.zoom||1,r=-(a.x||0)/l,o=-(a.y||0)/l,n=this.worldSize*2,s=this.warpSpeed||0,m=this.warpDisengaging,c=(d,g=1,f=2e3)=>{if(d)if(m){if(d.flownOut=!1,!d.disengageInit){const x=Math.random()*Math.PI*2,b=200+Math.random()*f,M=.3+Math.random()*1.4;d.finalX=r+Math.cos(x)*b,d.finalY=o+Math.sin(x)*b,d.depth=M,d.startX=r,d.startY=o,d.warpScale=.01,d.warpAlpha=0,d.disengageInit=!0}const p=1-Math.min(1,(s||0)/25);d.x=d.startX+(d.finalX-d.startX)*p,d.y=d.startY+(d.finalY-d.startY)*p;const v=p*p*p;d.warpScale=.01+v*.99,d.warpScale=Math.min(1,Math.max(.01,d.warpScale));const w=.35,S=Math.max(0,(p-w)/(1-w));d.warpAlpha=S;return}else{if(d.flownOut)return;const u=d.x-r,y=d.y-o,p=Math.sqrt(u*u+y*y);if(p<5){const z=Math.random()*Math.PI*2;d.x+=Math.cos(z)*20,d.y+=Math.sin(z)*20;return}const v=u/p,w=y/p,S=1/(this.camera.zoom||1),x=1+p/this.worldSize*1.2,b=d.depth||.5,C=s*x*10.5*b*g*4*S;d.x+=v*C,d.y+=w*C,p>n&&(d.flownOut=!0,d.wasFlownOut=!0)}};let h=0;this.planets&&this.planets.forEach((d,g)=>{d.depth=d.depth||.6,d.typeIndex=h++,c(d,.8,3e3)}),this.galaxies&&this.galaxies.forEach((d,g)=>{d.depth=d.depth||.4,d.typeIndex=h++,c(d,.5,5e3)}),this.blackHoles&&this.blackHoles.forEach((d,g)=>{d.depth=d.depth||.3,d.typeIndex=h++,c(d,.4,4e3)}),this.nebulae&&this.nebulae.forEach((d,g)=>{d.depth=d.depth||.5,d.typeIndex=h++,c(d,.6,4e3)}),this.spacecraft&&this.spacecraft.forEach((d,g)=>{d.depth=d.depth||.8,d.typeIndex=h++,c(d,1.2,2e3)}),this.stars&&this.stars.length>0&&this.stars.forEach((d,g)=>{d.depth=d.depth||.7,d.typeIndex=h++,c(d,.9,2500)})}catch(e){console.error("[WARP] Animation error:",e)}this.draw(t),requestAnimationFrame(this.animate)}draw(t){const{ctx:e,canvas:i}=this;if(e.setTransform(1,0,0,1,0,0),e.fillStyle=this.config.bgColor,e.fillRect(0,0,i.width,i.height),this.config.showBackground){const h=this.camera.x*.05,d=this.camera.y*.05;try{const g=i.width/2,f=i.height/2,u=Math.sqrt(g*g+f*f),y=performance.now()/1e3;this.staticStars.forEach(p=>{if(typeof p.x!="number"||typeof p.y!="number")return;let v=(p.x+h)%i.width,w=(p.y+d)%i.height;v<0&&(v+=i.width),w<0&&(w+=i.height);const S=typeof p.vx=="number"?p.vx:0,x=typeof p.vy=="number"?p.vy:0,b=p.r||p.size||1,M=p.color||"#ffffff";let C=255,z=255,E=255;try{if(M.startsWith("#")){const P=M.slice(1),I=parseInt(P.substr(0,2),16),T=parseInt(P.substr(2,2),16),A=parseInt(P.substr(4,2),16);C=isNaN(I)?255:I,z=isNaN(T)?255:T,E=isNaN(A)?255:A}}catch{}if(this.bgWarpMode&&!this.bgDriftMode){const P=v-g,I=w-f,T=Math.sqrt(P*P+I*I);if(T<3)return;const A=this.warpSpeed||0,H=this.warpSpeedMultiplier||1,N=T/u,G=p.depth||.5,Z=5+Math.sqrt(H)*14*G*(2+N*12),$=Math.min(Z,1680*G),Y=P/T,X=I/T,D=v,k=w,R=v-Y*$,L=w-X*$,U=p.alpha||.2,V=Math.min(.4,A*.15),F=Math.min(.65,U+V);if(e.globalAlpha=F,$>2)try{const B=e.createLinearGradient(R,L,D,k);B.addColorStop(0,"transparent"),B.addColorStop(.3,`rgba(${C}, ${z}, ${E}, 0.2)`),B.addColorStop(.6,`rgba(${C}, ${z}, ${E}, 0.6)`);const Q=Math.min(255,C+40),j=Math.min(255,z+40),tt=Math.min(255,E+40);B.addColorStop(1,`rgba(${Q}, ${j}, ${tt}, 1)`),e.strokeStyle=B;const et=Math.max(.6,Math.min(6,b*2+A*.06));if(e.lineWidth=et,e.lineCap="round",e.beginPath(),e.moveTo(R,L),e.lineTo(D,k),e.stroke(),$>15){const at=Math.min(255,C+80),it=Math.min(255,z+80),ot=Math.min(255,E+80);e.strokeStyle=`rgba(${at}, ${it}, ${ot}, 0.85)`,e.lineWidth=Math.max(.4,b*.3),e.globalAlpha=F*.9,e.beginPath();const O=Math.min($*.12,30),st=D-Y*O,nt=k-X*O;e.moveTo(st,nt),e.lineTo(D,k),e.stroke()}}catch{e.strokeStyle=M,e.lineWidth=b,e.beginPath(),e.moveTo(R,L),e.lineTo(D,k),e.stroke()}e.globalAlpha=Math.min(.9,F+.2);const q=Math.min(255,C+100),_=Math.min(255,z+100),J=Math.min(255,E+100);e.fillStyle=`rgb(${q}, ${_}, ${J})`,e.beginPath();const K=Math.max(.5,Math.min(1.2,b*.4));e.arc(D,k,K,0,Math.PI*2),e.fill()}else this.bgDriftMode&&this.bgWarpMode,e.globalAlpha=p.alpha||.5,e.fillStyle=M,e.beginPath(),e.arc(v,w,b,0,Math.PI*2),e.fill()})}catch(g){console.error("[BG Error] Star rendering failed:",g)}if(!this.bgWarpMode&&!this.bgDriftMode){const g=performance.now();if(g-this.lastShootingStarTime>2e3+Math.random()*4e3){this.lastShootingStarTime=g;const f=this.starColors||["#ffffff","#aaddff","#ffddaa"],u=Math.floor(Math.random()*4);let y,p,v;u===0?(y=Math.random()*i.width,p=-10,v=Math.PI*.25+Math.random()*Math.PI*.5):u===1?(y=i.width+10,p=Math.random()*i.height,v=Math.PI*.75+Math.random()*Math.PI*.5):u===2?(y=Math.random()*i.width,p=i.height+10,v=-Math.PI*.25-Math.random()*Math.PI*.5):(y=-10,p=Math.random()*i.height,v=-Math.PI*.25+Math.random()*Math.PI*.5),this.shootingStarsActive.push({x:y,y:p,vx:Math.cos(v)*(8+Math.random()*12),vy:Math.sin(v)*(8+Math.random()*12),size:1.5+Math.random()*1.5,tailLength:30+Math.random()*50,color:f[Math.floor(Math.random()*f.length)],life:1})}this.shootingStarsActive=this.shootingStarsActive.filter(f=>{if(f.x+=f.vx,f.y+=f.vy,f.life-=.01,f.life<=0||f.x<-100||f.x>i.width+100||f.y<-100||f.y>i.height+100)return!1;const u=Math.sqrt(f.vx*f.vx+f.vy*f.vy),y=-f.vx/u,p=-f.vy/u,v=f.x+y*f.tailLength,w=f.y+p*f.tailLength;return e.globalAlpha=f.life*.8,e.strokeStyle=f.color,e.lineWidth=f.size,e.lineCap="round",e.beginPath(),e.moveTo(v,w),e.lineTo(f.x,f.y),e.stroke(),e.fillStyle="#ffffff",e.beginPath(),e.arc(f.x,f.y,f.size*1.2,0,Math.PI*2),e.fill(),!0})}if(e.globalAlpha=1,this.activeStyles.has("cyber")&&this.matrixStreams){console.log("[Matrix Render] Drawing",this.matrixStreams.length,"streams"),e.textAlign="center";const g=this.matrixSpeedMultiplier||1,f=this.matrixLengthMultiplier||1;this.matrixAngle!==0&&(e.save(),e.translate(i.width/2,i.height/2),e.rotate(this.matrixAngle*Math.PI/180),e.translate(-i.width/2,-i.height/2));const u=20,y=Date.now()*.1;this.matrixStreams.forEach((p,v)=>{p.y+=p.baseSpeed*g;const w=Math.max(3,Math.floor(u*f));p.y-w*p.size>i.height*1.5&&(p.y=-p.size*w),e.font=`${p.size}px monospace, 'Courier New', monospace`,e.textBaseline="middle";for(let S=0;S<w&&S<p.chars.length;S++){const x=p.chars[S],b=p.y-S*p.size;if(b<-p.size*2||b>i.height*1.5)continue;const M=1-S/w,C=Math.pow(M,.5)*p.opacity;if(e.globalAlpha=C,this.matrixRainbowMode){const z=(y+v*15+S*5)%360;e.fillStyle=`hsl(${z}, 100%, 60%)`}else e.fillStyle=p.color;e.shadowBlur=4,e.shadowColor=p.color,e.fillText(x,p.x,b)}}),this.matrixAngle!==0&&e.restore(),e.shadowBlur=0,e.globalAlpha=1}}e.translate(i.width/2+this.camera.x,i.height/2+this.camera.y),e.scale(this.camera.zoom,this.camera.zoom);const{lines:a,clusters:l}=this.refreshClusterAssignments();if(this.drawBackgroundElements(),this.activeStyles.has("deep-space")&&this.drawDeepSpaceSpecific(),a.length>0){e.lineCap="round",e.shadowBlur=10;const h=this._cachedRotationCenter||this.getConstellationCenter(),d=h.x,g=h.y;h.z,a.forEach(f=>{const u=Math.max(0,1-f.dist/this.config.maxConnectDist),y=this.getStarColor(f.s1),[p,v,w]=this.hexToRgb(y),S=f.s1.z||0,x=f.s2.z||0,b=this.rotate3D(f.s1.x,f.s1.y,S,d,g),M=this.rotate3D(f.s2.x,f.s2.y,x,d,g);e.shadowColor=`rgba(${p}, ${v}, ${w}, 0.8)`,e.strokeStyle=`rgba(${p}, ${v}, ${w}, ${u*.3})`,e.lineWidth=3/this.camera.zoom,e.beginPath(),e.moveTo(b.x,b.y),e.lineTo(M.x,M.y),e.stroke()}),e.shadowBlur=0,a.forEach(f=>{const u=Math.max(0,1-f.dist/this.config.maxConnectDist),y=this.getStarColor(f.s1),p=f.s1.z||0,v=f.s2.z||0,w=this.rotate3D(f.s1.x,f.s1.y,p,d,g),S=this.rotate3D(f.s2.x,f.s2.y,v,d,g);e.strokeStyle=y,e.globalAlpha=u*.8,e.lineWidth=1/this.camera.zoom,e.beginPath(),e.moveTo(w.x,w.y),e.lineTo(S.x,S.y),e.stroke()}),e.globalAlpha=1}e.textAlign="center",e.textBaseline="middle",e.font=`600 ${14/this.camera.zoom}px 'Exo 2'`,l.forEach(h=>{const d=String(h[0].clusterId);if(h.length<this.config.minGroupSize||d===String(h[0].id))return;let g=0,f=0;h.forEach(y=>{g+=y.x,f+=y.y}),g/=h.length,f/=h.length;const u=this.getStarColor(h[0]);e.fillStyle=u,e.shadowColor="black",e.shadowBlur=4,e.fillText(d,g,f+30/this.camera.zoom),e.shadowBlur=0});const r=performance.now(),o=this._cachedRotationCenter||this.getConstellationCenter(),n=o.x,s=o.y;this.stars.forEach(h=>{if(h.flownOut)return;e.save();let d=1,g=1;this.warpDisengaging&&h.warpScale!==void 0&&(d=h.warpScale,g=h.warpAlpha!==void 0?h.warpAlpha:1);const f=h===this.hoveredStar,u=h.z||0,y=this.rotate3D(h.x,h.y,u,n,s),p=y.x,v=y.y,w=y.scale,S=Math.sin(r*.003+h.phase)*.2+.8,x=f?1.5:1,b=this.config.starBaseRad*S*x*w*d/this.camera.zoom,M=this.getStarColor(h),[C,z,E]=this.hexToRgb(M);e.globalAlpha=g;const P=Math.max(.1,b*6),I=e.createRadialGradient(p,v,0,p,v,P);I.addColorStop(0,`rgba(255, 255, 255, ${f?.9:.6})`),I.addColorStop(.2,`rgba(${C}, ${z}, ${E}, 0.3)`),I.addColorStop(1,"rgba(0,0,0,0)"),e.fillStyle=I,e.beginPath(),e.arc(p,v,P,0,Math.PI*2),e.fill(),e.fillStyle=M,this.drawStarShape(e,p,v,b),e.restore()});const m=document.getElementById("stats"),c=l.filter(h=>h.length>=this.config.minGroupSize).length;m&&(m.innerText=`Mode: ${this.mode.charAt(0).toUpperCase()+this.mode.slice(1)} | Stars: ${this.stars.length} | Constellations: ${c} | Zoom: ${this.camera.zoom.toFixed(2)}x`),this.flightMode&&this.playerShip?(console.log("[Spacecraft Debug] Rendering player ship at",this.playerShip.x,this.playerShip.y),this.renderSpeedLines(e),this.renderMinerals(e,t),this.renderPlayerShip(e,t),this.renderCollectionNotifications(e)):console.log("[Spacecraft Debug] NOT rendering - flightMode:",this.flightMode,"playerShip:",!!this.playerShip)}renderSpeedLines(t){this.speedLines.forEach(e=>{t.save(),t.translate(e.x,e.y),t.globalAlpha=e.life*.5,t.strokeStyle="#88ccff",t.lineWidth=2/this.camera.zoom,t.beginPath(),t.moveTo(0,0),t.lineTo(-e.vx*3,-e.vy*3),t.stroke(),t.globalAlpha=1,t.restore()})}renderPlayerShip(t,e){const i=this.playerShip;if(!i)return;t.save(),t.translate(i.x,i.y),t.rotate(i.rotation);const a=i.roll||0;t.rotate(a);const l=i.pitch||0,r=Math.cos(l),o=40/this.camera.zoom;switch(i.type||"interceptor"){case"saucer":t.fillStyle="#ffcc00",t.strokeStyle="#ff9900",t.lineWidth=2/this.camera.zoom,t.beginPath(),t.ellipse(0,0,o,o*.4,0,0,Math.PI*2),t.fill(),t.stroke(),t.fillStyle="#66ffff",t.beginPath(),t.ellipse(0,-o*.15,o*.5,o*.35,0,Math.PI,0),t.fill();for(let c=0;c<6;c++){const h=c/6*Math.PI*2+e*.005;t.fillStyle=c%2===0?"#ff0000":"#00ff00",t.beginPath(),t.arc(Math.cos(h)*o*.8,Math.sin(h)*o*.3,o*.08,0,Math.PI*2),t.fill()}break;case"hauler":t.fillStyle="#666666",t.strokeStyle="#888888",t.lineWidth=2/this.camera.zoom,t.fillRect(-o*.8,-o*.5,o*1.6,o),t.strokeRect(-o*.8,-o*.5,o*1.6,o),t.fillStyle="#884400",t.fillRect(-o*.5,-o*.35,o*.4,o*.7),t.fillRect(0,-o*.35,o*.4,o*.7),t.fillStyle="#00aaff",t.beginPath(),t.moveTo(o*.8,0),t.lineTo(o*.5,-o*.3),t.lineTo(o*.5,o*.3),t.closePath(),t.fill(),t.fillStyle="#ff4400",t.fillRect(-o*.9,-o*.4,o*.15,o*.25),t.fillRect(-o*.9,o*.15,o*.15,o*.25);break;case"orion":t.fillStyle="#ffffff",t.strokeStyle="#aaddff",t.lineWidth=2/this.camera.zoom,t.beginPath();for(let c=0;c<5;c++){const h=c*Math.PI*2/5-Math.PI/2,d=h+Math.PI/5,g=Math.cos(h)*o,f=Math.sin(h)*o,u=Math.cos(d)*o*.4,y=Math.sin(d)*o*.4;c===0?t.moveTo(g,f):t.lineTo(g,f),t.lineTo(u,y)}t.closePath(),t.fill(),t.stroke(),t.fillStyle="#00ccff",t.beginPath(),t.arc(0,0,o*.25,0,Math.PI*2),t.fill();break;case"draco":t.fillStyle="#22aa44",t.strokeStyle="#00ff66",t.lineWidth=3/this.camera.zoom,t.beginPath(),t.moveTo(o,0),t.lineTo(o*.7,-o*.4),t.lineTo(o*.5,-o*.2),t.lineTo(0,-o*.5),t.lineTo(-o*.5,-o*.3),t.lineTo(-o,0),t.lineTo(-o*.5,o*.3),t.lineTo(0,o*.5),t.lineTo(o*.5,o*.2),t.lineTo(o*.7,o*.4),t.closePath(),t.fill(),t.stroke(),t.fillStyle="#ff0000",t.beginPath(),t.arc(o*.6,-o*.1,o*.1,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(255, ${100+Math.sin(e*.01)*50}, 0, 0.7)`,t.beginPath(),t.moveTo(o,0),t.lineTo(o*1.5,-o*.2),t.lineTo(o*1.3,0),t.lineTo(o*1.5,o*.2),t.closePath(),t.fill();break;case"phoenix":t.fillStyle="#ff4400",t.strokeStyle="#ffaa00",t.lineWidth=2/this.camera.zoom,t.beginPath(),t.moveTo(o,0),t.bezierCurveTo(o*.5,-o*.3,-o*.3,-o*.4,-o*.5,0),t.bezierCurveTo(-o*.3,o*.4,o*.5,o*.3,o,0),t.fill(),t.stroke(),t.fillStyle="#ff6600",t.beginPath(),t.moveTo(0,-o*.2),t.lineTo(-o*.3,-o*.9),t.lineTo(-o*.5,-o*.6),t.lineTo(-o*.7,-o*.8),t.lineTo(-o*.6,-o*.3),t.closePath(),t.fill(),t.beginPath(),t.moveTo(0,o*.2),t.lineTo(-o*.3,o*.9),t.lineTo(-o*.5,o*.6),t.lineTo(-o*.7,o*.8),t.lineTo(-o*.6,o*.3),t.closePath(),t.fill();const s=Math.sin(e*.02)*.2;t.fillStyle=`rgba(255, ${150+s*100}, 0, 0.8)`,t.beginPath(),t.moveTo(-o*.5,0),t.lineTo(-o*(1.2+s),-o*.15),t.lineTo(-o*(1+s),0),t.lineTo(-o*(1.2+s),o*.15),t.closePath(),t.fill();break;case"harvester":t.rotate(Math.PI/2),t.scale(1,r||1),t.fillStyle="#00ddff",t.strokeStyle="#0088ff",t.lineWidth=2/this.camera.zoom,t.beginPath();for(let c=0;c<6;c++){const h=Math.PI/3*c,d=-o*1.2+Math.cos(h)*o*.4,g=Math.sin(h)*o*.6;c===0?t.moveTo(d,g):t.lineTo(d,g)}t.closePath(),t.fill(),t.stroke(),t.beginPath();for(let c=0;c<6;c++){const h=Math.PI/3*c,d=o*1.2+Math.cos(h)*o*.4,g=Math.sin(h)*o*.6;c===0?t.moveTo(d,g):t.lineTo(d,g)}t.closePath(),t.fill(),t.stroke(),t.fillStyle="#888888",t.strokeStyle="#00ffff",t.lineWidth=2/this.camera.zoom,t.beginPath(),t.ellipse(0,0,o*.3,o*.25,0,0,Math.PI*2),t.fill(),t.stroke(),t.fillStyle="#00ffff",t.beginPath(),t.arc(0,0,o*.12,0,Math.PI*2),t.fill(),t.strokeStyle="#666666",t.lineWidth=3/this.camera.zoom,t.beginPath(),t.moveTo(-o*.3,0),t.lineTo(-o*.8,0),t.moveTo(o*.3,0),t.lineTo(o*.8,0),t.stroke();const m=.3+Math.sin(e*.005)*.2;t.fillStyle=`rgba(0, 255, 100, ${m})`,t.beginPath(),t.arc(-o*1.2,0,o*.15,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(o*1.2,0,o*.15,0,Math.PI*2),t.fill();break;case"interceptor":default:t.fillStyle="#00ffff",t.strokeStyle="#0088ff",t.lineWidth=3/this.camera.zoom,t.beginPath(),t.moveTo(o,0),t.lineTo(-o*.6,-o*.6),t.lineTo(-o*.4,0),t.lineTo(-o*.6,o*.6),t.closePath(),t.fill(),t.stroke(),t.fillStyle="#ff6600",t.beginPath(),t.arc(-o*.5,0,o*.2,0,Math.PI*2),t.fill();break}t.restore()}renderMinerals(t,e){this.minerals.forEach(i=>{t.save(),t.translate(i.x,i.y);const a=Math.max(.01,this.camera.zoom||1),l=Math.sin(e*.003+i.phase)*.3+.7,r=i.size*l/a;if(!isFinite(r)||r<=0){t.restore();return}const o=t.createRadialGradient(0,0,0,0,0,r*2);o.addColorStop(0,i.color),o.addColorStop(.5,i.color+"88"),o.addColorStop(1,i.color+"00"),t.fillStyle=o,t.beginPath(),t.arc(0,0,r*2,0,Math.PI*2),t.fill(),t.fillStyle=i.color,t.beginPath(),t.arc(0,0,r,0,Math.PI*2),t.fill(),t.fillStyle="#ffffff",t.globalAlpha=.5,t.beginPath(),t.arc(0,0,r*.4,0,Math.PI*2),t.fill(),t.globalAlpha=1,t.restore()})}renderCollectionNotifications(t){const e=this.canvas,i=Date.now();this.collectionNotifications.forEach(a=>{const l=i-a.time,r=Math.max(0,1-l/2e3),o=l*.05;t.save(),t.setTransform(1,0,0,1,0,0),t.globalAlpha=r,t.font="bold 20px Arial",t.fillStyle=a.color,t.strokeStyle="#000",t.lineWidth=3,t.textAlign="center";const n=e.width/2,s=e.height/2-100-o;t.strokeText(a.text,n,s),t.fillText(a.text,n,s),t.globalAlpha=1,t.restore()})}drawBackgroundElements(){if(!this.config.showBackground)return;const t=this.ctx;if(this.backgroundStars&&this.backgroundStars.length>0&&(this.backgroundStars.forEach(e=>{t.fillStyle=e.color||"white",t.globalAlpha=e.alpha,t.beginPath(),t.arc(e.x,e.y,e.r,0,Math.PI*2),t.fill()}),t.globalAlpha=1),this.nebulae&&this.nebulae.length>0&&(t.globalCompositeOperation="screen",this.nebulae.forEach(e=>{if(e.flownOut)return;let i=1,a=1;this.warpDisengaging&&e.warpScale!==void 0&&(i=e.warpScale||.01,a=e.warpAlpha||0);const l=Math.max(.1,e.size*i),r=e.alpha*a,o=t.createRadialGradient(e.x,e.y,0,e.x,e.y,l);o.addColorStop(0,e.color),o.addColorStop(1,"transparent"),t.globalAlpha=r,t.fillStyle=o,t.beginPath(),t.arc(e.x,e.y,l,0,Math.PI*2),t.fill()}),t.globalCompositeOperation="source-over",t.globalAlpha=1),this.activeStyles.has("deep-space")&&this.shootingStars&&this.shootingStars.length>0&&(this.shootingStars.forEach(e=>{t.save();const i=e.x-e.vx*e.tailLength,a=e.y-e.vy*e.tailLength,l=t.createLinearGradient(i,a,e.x,e.y);l.addColorStop(0,"transparent"),l.addColorStop(.7,e.color+"40"),l.addColorStop(1,e.color),t.strokeStyle=l,t.lineWidth=e.size*.8,t.lineCap="round",t.globalAlpha=e.alpha,t.beginPath(),t.moveTo(i,a),t.lineTo(e.x,e.y),t.stroke(),t.fillStyle=e.color,t.globalAlpha=e.alpha+.3,t.beginPath(),t.arc(e.x,e.y,e.size,0,Math.PI*2),t.fill(),t.restore()}),t.globalAlpha=1),this.activeStyles.has("alien")&&this.spacecraft&&this.spacecraft.length>0){const e=performance.now()*.001;this.spacecraft.forEach(i=>{if(i.flownOut)return;t.save(),t.translate(i.x,i.y),this.warpDisengaging&&i.warpScale!==void 0&&(t.scale(i.warpScale,i.warpScale),t.globalAlpha=i.warpAlpha||0),i.rotationSpeed&&(i.rotation+=i.rotationSpeed);const a=i.size,l=this.camera.zoom,r=Math.atan2(i.vy,i.vx);if(i.hasShield){const n=Math.sin(e*2+i.shieldPhase)*.3+.4;t.globalAlpha=n*.4;const s=t.createRadialGradient(0,0,a*.5,0,0,a*1.5);s.addColorStop(0,"transparent"),s.addColorStop(.7,i.shieldColor||"rgba(100,200,255,0.3)"),s.addColorStop(1,"transparent"),t.fillStyle=s,t.beginPath(),t.arc(0,0,a*1.5,0,Math.PI*2),t.fill(),t.globalAlpha=1}if(i.beamActive&&i.shipClass==="saucer"){const n=Math.sin(e*5)*.2+.6;t.globalAlpha=n*.5;const s=t.createLinearGradient(0,a*.2,0,a*3);s.addColorStop(0,i.beamColor||"#88ff88"),s.addColorStop(1,"transparent"),t.fillStyle=s,t.beginPath(),t.moveTo(-a*.3,a*.2),t.lineTo(-a*.8,a*3),t.lineTo(a*.8,a*3),t.lineTo(a*.3,a*.2),t.closePath(),t.fill(),t.globalAlpha=1}if(i.shipClass!=="saucer"&&t.rotate(r),i.shipClass!=="saucer"&&i.shipClass!=="probe"){t.globalAlpha=.7;const n=a*2,s=a*.25,m=i.engineCount||2;for(let c=0;c<m;c++){const h=(c-(m-1)/2)*s,d=.7+Math.sin(e*15+i.detailSeed+c)*.3,g=t.createLinearGradient(-a*.7,h,-a*.7-n*d,h);g.addColorStop(0,i.engineGlow||"#ffffff"),g.addColorStop(.15,i.engineColor||"#00aaff"),g.addColorStop(1,"transparent"),t.fillStyle=g,t.beginPath(),t.moveTo(-a*.65,h-4),t.quadraticCurveTo(-a*.7-n*.5*d,h,-a*.7-n*d,h),t.quadraticCurveTo(-a*.7-n*.5*d,h,-a*.65,h+4),t.closePath(),t.fill()}t.globalAlpha=1}const o=t.createLinearGradient(0,-a*.5,0,a*.5);if(o.addColorStop(0,i.hullHighlight||"#ccc"),o.addColorStop(.3,i.hullColor||"#888"),o.addColorStop(1,i.hullShadow||"#333"),t.fillStyle=o,t.strokeStyle=i.hullHighlight||"#ddd",t.lineWidth=1.5/l,i.shipClass==="saucer"){t.beginPath(),t.ellipse(0,0,a,a*.25,0,0,Math.PI*2),t.fill(),t.stroke();const n=t.createRadialGradient(-a*.1,-a*.15,0,0,-a*.05,a*.4);n.addColorStop(0,"#ffffff"),n.addColorStop(.3,i.domeColor||"#88ffff"),n.addColorStop(1,"rgba(0,50,50,0.8)"),t.fillStyle=n,t.beginPath(),t.ellipse(0,-a*.08,a*.35,a*.25,0,Math.PI,0),t.fill()}else if(i.shipClass==="star-dreadnought"){t.beginPath(),t.moveTo(a*1.2,0);for(let n=0;n<6;n++){const s=n/6*Math.PI*2;t.lineTo(Math.cos(s)*a*.8,Math.sin(s)*a*.8)}t.closePath(),t.fill(),t.stroke()}else if(i.shipClass==="quantum-scout")for(let n=0;n<3;n++)t.save(),t.rotate(e*(2+n)+n),t.strokeStyle="#00aaff",t.lineWidth=2,t.beginPath(),t.ellipse(0,0,a*(.6+n*.3),a*.2,0,0,Math.PI*2),t.stroke(),t.restore();else if(i.shipClass==="void-fighter")t.beginPath(),t.moveTo(a*.9,0),t.lineTo(a*.2,-a*.5),t.lineTo(-a*.6,-a*.3),t.lineTo(-a*.6,a*.3),t.lineTo(a*.2,a*.5),t.closePath(),t.fill(),t.stroke();else if(i.shipClass==="nebula-cruiser"){const n=t.createLinearGradient(-a,0,a,0);n.addColorStop(0,"#606080"),n.addColorStop(.5,"#8080a0"),n.addColorStop(1,"#505070"),t.fillStyle=n,t.beginPath(),t.moveTo(a*1.2,0),t.lineTo(a*.7,-a*.08),t.lineTo(-a*.5,-a*.12),t.lineTo(-a*.8,0),t.lineTo(-a*.5,a*.12),t.lineTo(a*.7,a*.08),t.closePath(),t.fill(),t.stroke(),t.fillStyle="#7070a0",t.beginPath(),t.moveTo(a*.2,0),t.lineTo(-a*.3,-a*.6),t.lineTo(-a*.6,-a*.4),t.closePath(),t.fill(),t.beginPath(),t.moveTo(a*.2,0),t.lineTo(-a*.3,a*.6),t.lineTo(-a*.6,a*.4),t.closePath(),t.fill()}else if(i.shipClass==="bio-corvette"){const n=t.createLinearGradient(-a,0,a,0);n.addColorStop(0,"#4a0066"),n.addColorStop(.5,"#9900cc"),n.addColorStop(1,"#660099"),t.fillStyle=n,t.beginPath(),t.moveTo(a*.8,0),t.bezierCurveTo(a*.6,-a*.4,a*.2,-a*.5,-a*.3,-a*.3),t.bezierCurveTo(-a*.7,0,-a*.3,a*.3,a*.2,a*.5),t.bezierCurveTo(a*.6,a*.4,a*.8,0,a*.8,0),t.fill()}else if(i.shipClass==="warp-strider"){const n=t.createLinearGradient(-a,0,a,0);n.addColorStop(0,"#606060"),n.addColorStop(.5,"#a0a0a0"),n.addColorStop(1,"#505050"),t.fillStyle=n,t.beginPath(),t.moveTo(a*.8,0),t.lineTo(a*.3,-a*.15),t.lineTo(-a*.6,-a*.15),t.lineTo(-a*.8,0),t.lineTo(-a*.6,a*.15),t.lineTo(a*.3,a*.15),t.closePath(),t.fill(),t.fillStyle="#707070",t.fillRect(-a*.7,-a*.5,a*.4,a*.08),t.fillRect(-a*.7,a*.42,a*.4,a*.08)}else if(i.shipClass==="prism-destroyer"){const n=t.createLinearGradient(-a,-a,a,a);n.addColorStop(0,"#c0c0c0"),n.addColorStop(.5,"#e8e8e8"),n.addColorStop(1,"#707070"),t.fillStyle=n,t.beginPath(),t.moveTo(a,0),t.lineTo(a*.3,-a*.6),t.lineTo(-a*.5,-a*.5),t.lineTo(-a*.8,0),t.lineTo(-a*.5,a*.5),t.lineTo(a*.3,a*.6),t.closePath(),t.fill(),t.stroke()}else if(i.shipClass==="stellar-barge"){const n=t.createLinearGradient(-a,0,a,0);n.addColorStop(0,"#4a3820"),n.addColorStop(.5,"#8B6F47"),n.addColorStop(1,"#3a2810"),t.fillStyle=n,t.fillRect(-a*.7,-a*.35,a*1.3,a*.7),t.fillStyle="#5a4830",t.beginPath(),t.moveTo(a*.7,-a*.25),t.lineTo(a,0),t.lineTo(a*.7,a*.25),t.closePath(),t.fill()}else if(i.shipClass==="cyber-sentry"){const n=t.createRadialGradient(0,0,0,0,0,a*.4);n.addColorStop(0,"#ff0000"),n.addColorStop(.5,"#880000"),n.addColorStop(1,"#220000"),t.fillStyle=n,t.beginPath(),t.arc(0,0,a*.35,0,Math.PI*2),t.fill();for(let s=0;s<8;s++){const m=s/8*Math.PI*2+e;t.strokeStyle="#ff0000",t.lineWidth=2,t.beginPath(),t.moveTo(Math.cos(m)*a*.4,Math.sin(m)*a*.4),t.lineTo(Math.cos(m)*a*.8,Math.sin(m)*a*.8),t.stroke()}}else if(i.shipClass==="aether-wing"){const n=t.createLinearGradient(-a,0,a,0);n.addColorStop(0,"rgba(0,100,255,0)"),n.addColorStop(.5,"rgba(100,200,255,0.6)"),n.addColorStop(1,"rgba(0,100,255,0)"),t.fillStyle=n,t.beginPath(),t.moveTo(-a*.8,-a*.6),t.lineTo(a*.8,0),t.lineTo(-a*.8,a*.6),t.closePath(),t.fill()}else if(i.shipClass==="death-sphere"){const n=t.createRadialGradient(-a*.2,-a*.2,0,0,0,a);n.addColorStop(0,"#505050"),n.addColorStop(.5,"#303030"),n.addColorStop(1,"#101010"),t.fillStyle=n,t.beginPath(),t.arc(0,0,a,0,Math.PI*2),t.fill(),t.stroke();const s=t.createRadialGradient(a*.4,-a*.4,0,a*.4,-a*.4,a*.12);s.addColorStop(0,"#00ff00"),s.addColorStop(.5,"#00aa00"),s.addColorStop(1,"rgba(0,170,0,0)"),t.fillStyle=s,t.beginPath(),t.arc(a*.4,-a*.4,a*.1,0,Math.PI*2),t.fill()}else if(i.shipClass==="tie-fighter"){const n=t.createRadialGradient(0,0,0,0,0,a*.3);n.addColorStop(0,"#606060"),n.addColorStop(.7,"#303030"),n.addColorStop(1,"#101010"),t.fillStyle=n,t.beginPath();for(let m=0;m<6;m++){const c=m/6*Math.PI*2-Math.PI/2,h=Math.cos(c)*a*.25,d=Math.sin(c)*a*.25;m===0?t.moveTo(h,d):t.lineTo(h,d)}t.closePath(),t.fill(),t.stroke();const s=t.createLinearGradient(-a,-a,a,a);s.addColorStop(0,"#404040"),s.addColorStop(.5,"#505050"),s.addColorStop(1,"#303030"),t.fillStyle=s,t.fillRect(-a*1.2,-a*.8,a*.8,a*1.6),t.strokeRect(-a*1.2,-a*.8,a*.8,a*1.6),t.fillRect(a*.4,-a*.8,a*.8,a*1.6),t.strokeRect(a*.4,-a*.8,a*.8,a*1.6)}else t.beginPath(),t.arc(0,0,a*.5,0,Math.PI*2),t.fill(),t.stroke();if(i.shipClass!=="probe"&&i.shipClass!=="saucer"){const n=Math.sin(e*3+(i.lightPhase||0))*.5+.5;t.fillStyle=i.lightColor||"#ff00ff",t.globalAlpha=n,t.beginPath(),t.arc(a*.85,0,3/l,0,Math.PI*2),t.fill(),t.fillStyle="#00ff00",t.beginPath(),t.arc(-a*.5,-a*.6,2/l,0,Math.PI*2),t.fill(),t.fillStyle="#ff0000",t.beginPath(),t.arc(-a*.5,a*.6,2/l,0,Math.PI*2),t.fill(),t.globalAlpha=1}t.restore()})}}drawDeepSpaceSpecific(){if(!this.config.showBackground)return;const t=this.ctx,e=performance.now()*5e-4;if(this.galaxies&&this.galaxies.length>0&&this.galaxies.forEach(i=>{if(i.flownOut)return;t.save(),t.translate(i.x,i.y),this.warpDisengaging&&i.warpScale!==void 0&&(t.scale(i.warpScale,i.warpScale),t.globalAlpha=i.warpAlpha||0),t.rotate(i.angle+e*.1);const a=t.createRadialGradient(0,0,0,0,0,i.size);a.addColorStop(0,"rgba(255,255,255,0.8)"),a.addColorStop(.2,i.color),a.addColorStop(1,"transparent"),t.fillStyle=a,t.beginPath();for(let l=0;l<3;l++)t.rotate(Math.PI*2/3),t.ellipse(0,0,i.size,i.size/4,0,0,Math.PI*2);t.fill(),t.restore()}),this.blackHoles&&this.blackHoles.length>0&&this.blackHoles.forEach(i=>{i.flownOut||(t.save(),t.translate(i.x,i.y),this.warpDisengaging&&i.warpScale!==void 0&&(t.scale(i.warpScale,i.warpScale),t.globalAlpha=i.warpAlpha||0),t.beginPath(),t.strokeStyle="orange",t.lineWidth=2,t.arc(0,0,i.size*1.5,0,Math.PI*2),t.stroke(),t.beginPath(),t.fillStyle="black",t.arc(0,0,i.size,0,Math.PI*2),t.fill(),t.shadowColor="purple",t.shadowBlur=20,t.stroke(),t.shadowBlur=0,t.restore())}),this.planets&&this.planets.length>0){const i=this.camera.zoom;this.planets.forEach(a=>{if(a.flownOut)return;t.save(),t.translate(a.x,a.y),this.warpDisengaging&&a.warpScale!==void 0&&(t.scale(a.warpScale,a.warpScale),t.globalAlpha=a.warpAlpha||0),t.rotate(a.axialTilt);const l=a.radius*i,r=Math.min(3,Math.floor(l/30));if(a.hasRings&&this.drawPlanetRingsHalf(t,a,"back"),a.hasAtmosphere){const s=t.createRadialGradient(0,0,a.radius*.95,0,0,a.radius*1.15);s.addColorStop(0,"transparent"),s.addColorStop(.5,a.atmosphereColor+"40"),s.addColorStop(1,"transparent"),t.fillStyle=s,t.beginPath(),t.arc(0,0,a.radius*1.15,0,Math.PI*2),t.fill()}const o=t.createRadialGradient(-a.radius*.3,-a.radius*.3,0,0,0,a.radius);if(o.addColorStop(0,a.secondaryColor),o.addColorStop(.4,a.baseColor),o.addColorStop(.8,a.tertiaryColor),o.addColorStop(1,"#000000"),t.fillStyle=o,t.beginPath(),t.arc(0,0,a.radius,0,Math.PI*2),t.fill(),r>=1){if(t.globalAlpha=.3,t.strokeStyle=a.tertiaryColor,t.lineWidth=2/i,a.type==="gas-giant"||a.type==="ice-giant")for(let s=-4;s<=4;s++){const m=a.radius*(s*.15),c=Math.sqrt(a.radius*a.radius-m*m);c>0&&(t.beginPath(),t.ellipse(0,m,c,3,0,0,Math.PI*2),t.stroke())}if((a.type==="terrestrial"||a.type==="ocean")&&r>=2){t.fillStyle=a.type==="ocean"?a.baseColor:a.secondaryColor;const s=a.textureSeed;for(let m=0;m<5;m++){const c=Math.cos(s+m*1.2)*a.radius*.5,h=Math.sin(s*.7+m)*a.radius*.4,d=a.radius*(.15+Math.sin(s+m)*.1);t.beginPath(),t.arc(c,h,d,0,Math.PI*2),t.fill()}}t.globalAlpha=1}const n=t.createLinearGradient(-a.radius,0,a.radius,0);n.addColorStop(0,"transparent"),n.addColorStop(.6,"transparent"),n.addColorStop(1,"rgba(0,0,0,0.6)"),t.fillStyle=n,t.beginPath(),t.arc(0,0,a.radius,0,Math.PI*2),t.fill(),a.hasRings&&this.drawPlanetRingsHalf(t,a,"front"),t.restore()})}}drawPlanetRingsHalf(t,e,i){const a=e;t.save(),t.beginPath(),i==="back"?t.rect(-a.ringOuterRadius*1.5,-a.ringOuterRadius,a.ringOuterRadius*3,a.ringOuterRadius):t.rect(-a.ringOuterRadius*1.5,0,a.ringOuterRadius*3,a.ringOuterRadius),t.clip(),t.globalAlpha=i==="back"?.4:.7;for(let l=0;l<5;l++){const r=a.ringInnerRadius+(a.ringOuterRadius-a.ringInnerRadius)*(l/5+.1),o=(a.ringOuterRadius-a.ringInnerRadius)*.12;t.strokeStyle=a.ringColor,t.lineWidth=o,t.beginPath(),t.ellipse(0,0,r,r*.25,0,0,Math.PI*2),t.stroke()}t.restore()}drawStarShape(t,e,i,a){t.beginPath();const l=a*.5;t.moveTo(e,i-a),t.lineTo(e+l,i-l),t.lineTo(e+a,i),t.lineTo(e+l,i+l),t.lineTo(e,i+a),t.lineTo(e-l,i+l),t.lineTo(e-a,i),t.lineTo(e-l,i-l),t.closePath(),t.fill()}getConstellationCenter(){if(this.stars.length===0)return{x:this.canvas.width/2,y:this.canvas.height/2,z:0};let t=0,e=0,i=0;return this.stars.forEach(a=>{t+=a.x,e+=a.y,i+=a.z||0}),{x:t/this.stars.length,y:e/this.stars.length,z:i/this.stars.length}}rotate3D(t,e,i,a,l){const r=this.rotationX*Math.PI/180,o=this.rotationY*Math.PI/180,n=this.rotationZ*Math.PI/180;let s=t-a,m=e-l,c=i,h=m*Math.cos(r)-c*Math.sin(r),d=m*Math.sin(r)+c*Math.cos(r);m=h,c=d;let g=s*Math.cos(o)+c*Math.sin(o);d=-s*Math.sin(o)+c*Math.cos(o),s=g,c=d,g=s*Math.cos(n)-m*Math.sin(n),h=s*Math.sin(n)+m*Math.cos(n),s=g,m=h;const f=800,u=f/(f+c);return{x:s*u+a,y:m*u+l,scale:u}}inverseRotate3D(t,e,i,a){const l=-this.rotationX*Math.PI/180,r=-this.rotationY*Math.PI/180,o=-this.rotationZ*Math.PI/180;let n=t-i,s=e-a,m=0,c=n*Math.cos(o)-s*Math.sin(o),h=n*Math.sin(o)+s*Math.cos(o);n=c,s=h,c=n*Math.cos(r)+m*Math.sin(r);let d=-n*Math.sin(r)+m*Math.cos(r);return n=c,m=d,h=s*Math.cos(l)-m*Math.sin(l),d=s*Math.sin(l)+m*Math.cos(l),s=h,m=d,{x:n+i,y:s+a,z:m}}resetRotation(){this.rotationX=0,this.rotationY=0,this.rotationZ=0;const t=document.getElementById("rotXSlider"),e=document.getElementById("rotYSlider"),i=document.getElementById("rotZSlider");t&&(t.value=0,document.getElementById("rotXValue").textContent="0Â°"),e&&(e.value=0,document.getElementById("rotYValue").textContent="0Â°"),i&&(i.value=0,document.getElementById("rotZValue").textContent="0Â°")}calculateGeometry(){const t=[],e={},i=new Map;this.stars.forEach(r=>{e[r.id]=[],i.set(r.id,r)});for(let r=0;r<this.stars.length;r++)for(let o=r+1;o<this.stars.length;o++){const n=this.stars[r],s=this.stars[o],m=Math.hypot(n.x-s.x,n.y-s.y);m<this.config.maxConnectDist&&(t.push({s1:n,s2:s,dist:m}),e[n.id].push(s.id),e[s.id].push(n.id))}const a=[],l=new Set;return this.stars.forEach(r=>{if(!l.has(r.id)){const o=[],n=[r.id];for(l.add(r.id);n.length;){const s=n.shift(),m=i.get(s);m&&o.push(m),e[s].forEach(c=>{l.has(c)||(l.add(c),n.push(c))})}o.length>0&&a.push(o)}}),{lines:t,clusters:a}}showToast(t){console.log("[Toast]",t);let e=document.getElementById("toast");e||(e=document.createElement("div"),e.id="toast",e.style.cssText="position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:white;padding:10px 20px;border-radius:8px;z-index:9999;transition:opacity 0.3s",document.body.appendChild(e)),e.textContent=t,e.style.opacity="1",clearTimeout(this._toastTimeout),this._toastTimeout=setTimeout(()=>{e.style.opacity="0"},2e3)}showShipModal(){const t=document.getElementById("shipModal");t&&t.classList.add("active")}hideShipModal(){const t=document.getElementById("shipModal");t&&t.classList.remove("active")}selectShip(t){const i={interceptor:{name:"Interceptor",maxSpeed:50,acceleration:.5},saucer:{name:"Saucer",maxSpeed:70,acceleration:.7},hauler:{name:"Hauler",maxSpeed:30,acceleration:.3},orion:{name:"Orion",maxSpeed:60,acceleration:.6},draco:{name:"Draco",maxSpeed:80,acceleration:.4},phoenix:{name:"Phoenix",maxSpeed:55,acceleration:.8},harvester:{name:"Starfighter",maxSpeed:80,acceleration:.8}}[t];i&&this.playerShip&&(this.playerShip.type=t,this.playerShip.maxSpeed=i.maxSpeed,this.playerShip.acceleration=i.acceleration,this.showToast(`Selected ${i.name}`)),this.hideShipModal()}downloadSVG(){if(this.stars.length===0){this.showToast("Universe is empty!");return}this.refreshClusterAssignments();let t=1/0,e=1/0,i=-1/0,a=-1/0;this.stars.forEach(p=>{t=Math.min(t,p.x),e=Math.min(e,p.y),i=Math.max(i,p.x),a=Math.max(a,p.y)});const l=100,r=i-t+l*2,o=a-e+l*2,n=t-l,s=e-l,{lines:m,clusters:c}=this.calculateGeometry();let h=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="${n} ${s} ${r} ${o}" style="background:#020205">
            <rect x="${n}" y="${s}" width="${r}" height="${o}" fill="#020205"/>`;m.forEach(p=>{const v=(1-p.dist/this.config.maxConnectDist).toFixed(2),[w,S,x]=this.hexToRgb(this.getStarColor(p.s1));h+=`<line x1="${p.s1.x}" y1="${p.s1.y}" x2="${p.s2.x}" y2="${p.s2.y}" stroke="rgb(${w}, ${S}, ${x})" stroke-width="1.5" stroke-linecap="round" opacity="${v*.8}"/>`}),c.forEach(p=>{const v=String(p[0].clusterId);if(p.length<this.config.minGroupSize||v===String(p[0].id))return;let w=0,S=0;p.forEach(b=>{w+=b.x,S+=b.y}),w/=p.length,S/=p.length;const x=this.getStarColor(p[0]);h+=`<text x="${w}" y="${S+30}" font-family="sans-serif" font-size="14" fill="${x}" text-anchor="middle" font-weight="600">${v}</text>`}),this.stars.forEach(p=>{const v=this.getStarColor(p),w=this.config.starBaseRad*1.5,S=w*.5,x=`M${p.x} ${p.y-w} L${p.x+S} ${p.y-S} L${p.x+w} ${p.y} L${p.x+S} ${p.y+S} L${p.x} ${p.y+w} L${p.x-S} ${p.y+S} L${p.x-w} ${p.y} L${p.x-S} ${p.y-S} Z`;h+=`<path d="${x}" fill="${v}" opacity="0.8"/>`,h+=`<circle cx="${p.x}" cy="${p.y}" r="1.5" fill="white" />`}),h+="</svg>";const d=new Blob([h],{type:"image/svg+xml;charset=utf-8"}),g=`AetherMap-${Date.now()}.svg`;if(typeof window.navigator.msSaveBlob<"u"){window.navigator.msSaveBlob(d,g),this.showToast("Map Exported");return}const f=window.URL.createObjectURL(d),u=document.createElement("a");u.href=f,u.download=g;const y=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});u.dispatchEvent(y),setTimeout(()=>{window.URL.revokeObjectURL(f)},1e3),this.showToast("Map Exported")}downloadPNG(){const t=`Interstellar-${Date.now()}.png`,e=document.createElement("a");e.download=t,e.href=this.canvas.toDataURL("image/png");const i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});e.dispatchEvent(i),this.showToast("Image saved as "+t)}triggerLoadSVG(){document.getElementById("svgFileInput").click()}loadSVG(t){const e=t.target.files[0];if(!e)return;const i=new FileReader;i.onload=a=>{try{const l=a.target.result,n=new DOMParser().parseFromString(l,"image/svg+xml").querySelectorAll("path[fill][opacity]");if(n.length===0){this.showToast("No stars found in SVG");return}this.stars=[],this.history=[],n.forEach((s,m)=>{const c=s.getAttribute("d"),h=s.getAttribute("fill"),d=c.match(/M([-\d.]+)\s+([-\d.]+)/);if(d){const g=parseFloat(d[1]),f=parseFloat(d[2]),u=this.config.starBaseRad*1.5,y=f+u;this.stars.push({id:Date.now()+m,x:g,y,color:h,phase:Math.random()*Math.PI*2,clusterId:null})}}),t.target.value="",this.showToast(`Loaded ${this.stars.length} stars`),this.draw()}catch(l){console.error("Error parsing SVG:",l),this.showToast("Error loading SVG file")}},i.readAsText(e)}exportVideo(){if(this._isRecording){this.showToast("Already recording...");return}const t=document.getElementById("videoDuration"),e=t?parseInt(t.value):5e3,i=e/1e3;this._isRecording=!0;const a=document.getElementById("exportVideoBtn");a&&a.classList.add("active"),this.showToast(`Recording ${i} seconds...`);const l=this.canvas.captureStream(30),r=[],o=MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?"video/webm;codecs=vp9":"video/webm",n=new MediaRecorder(l,{mimeType:o});n.ondataavailable=s=>{s.data.size>0&&r.push(s.data)},n.onstop=()=>{this._isRecording=!1,a&&a.classList.remove("active");const s=new Blob(r,{type:o}),m=`Interstellar-${Date.now()}.webm`,c=window.URL.createObjectURL(s),h=document.createElement("a");h.href=c,h.download=m;const d=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});h.dispatchEvent(d),setTimeout(()=>{window.URL.revokeObjectURL(c)},1e3),this.showToast("Video exported!")},n.onerror=s=>{this._isRecording=!1,a&&a.classList.remove("active"),console.error("Recording error:",s),this.showToast("Recording failed")},n.start(),setTimeout(()=>{n.state==="recording"&&n.stop()},e)}}window.app=new rt;
//# sourceMappingURL=interstellar-Cu--zowH.js.map

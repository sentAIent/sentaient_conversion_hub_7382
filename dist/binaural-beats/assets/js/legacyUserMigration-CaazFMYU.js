const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/onboarding-Di5GE543.js","assets/js/dynamic-import-helper-CTnsj-vI.js","assets/js/array-YYQw31d9.js","assets/js/style-D-IRYiWS.js","assets/css/style-6nm_MYpP.css","assets/js/Logger-cMW5At62.js","assets/js/string-BBKP9xfj.js","assets/js/enums-1c3kgXdw.js","assets/js/helpers-BTpQmO5s.js","assets/js/TabLeaderElection-Ddi84wmm.js","assets/js/focusModeState-BPyBLUbE.js","assets/js/LocalStorageStoreSyncedItem-DMdfjgsv.js","assets/js/onboarding-B35lV45t.js","assets/js/compareObjects-R6Hcs7xe.js","assets/js/modal-BWwnzHDf.js","assets/js/SubscriptionSummary-BTlVYU_L.js","assets/js/persistStore-BDYPfxbs.js","assets/js/reactiveCustomization-CEUTOUc3.js","assets/js/VueBase-C55TLWt3.js","assets/js/_commonjsHelpers-B3K3fdV-.js","assets/js/ClickOutside-DCLvi2fj.js","assets/js/pinia-B4IAWUO-.js","assets/js/portal-vue.esm-DdddSpdW.js","assets/js/constants-CALDQiUE.js","assets/js/constants-BfBD_H-d.js","assets/js/authService-UjcjSrh8.js","assets/js/auth-BwdMrzFn.js","assets/js/login-HJtMK9QU.js","assets/js/icon-confetti-BvRSomF2.js","assets/js/focusModeHelpers-tDECULZC.js","assets/js/PomodoroTimers-CyrfcuWH.js","assets/js/experiments-6paecGsK.js","assets/js/siteBlockerGroups-BbPmPcem.js","assets/js/constants-Dqx3dGLK.js","assets/js/SettingsTypes-BotgHBzA.js","assets/js/accessToken-Cx8MZLdN.js","assets/js/tasksMockData-CwjLszHJ.js","assets/js/tasksViewState-qOrGChOD.js","assets/js/ViewState-DH0LvQYq.js","assets/js/appZStack-Zxx-wHpo.js"])))=>i.map(i=>d[i]);
import{_ as e}from"./style-D-IRYiWS.js";import{g as t}from"./Logger-cMW5At62.js";import{T as r,a}from"./dynamic-import-helper-CTnsj-vI.js";import{s as o}from"./enums-1c3kgXdw.js";import{L as s,a as i,b as n,c as g,d as c,m as l}from"./migrateLegacyUserMessageHandler-CZ8nZZlg.js";var u="https://api.momentumdash.com/",d="2.23.4";const I=new class{async migrateIfEligible(){if(this._meetsLockoutRestriction()&&await this._userIsRandomlySelected())if(localStorage.setItem(s.TIME,Date.now().toString()),await this._serviceWorkerIsResponsive())await this.migrateAll();else{const e="legacy user migration postponed due to worker not responding";new r(i).warn(e),console.warn(e)}}_meetsLockoutRestriction(){const e=localStorage.getItem(s.TIME);return!(e&&Number(e)+n>Date.now())}async _userIsRandomlySelected(){const e=await t("legacyUserMigrationPortion");return!!e&&m.utils.getPseudoRandomFromString(localStorage.getItem("client_uuid"))<=e}async _serviceWorkerIsResponsive(){return!m.utils.isWebApp()||new Promise((e=>{m.backgroundWorkerMessageBus.awaitWorkerReady().then((()=>e(!0))),setTimeout((()=>e(!1)),g)}))}async migrateAll(){m.migratingLegacyUser=!0;try{if(localStorage.getItem("token")||await this._migrateUser(),!localStorage.getItem(s.FOCUS))try{await this._migrateFocuses()}catch(e){this._logError(e,c.FOCUS)}if(!localStorage.getItem(s.ONBOARDING))try{await this._saveOnboardingIntroAsComplete()}catch(e){this._logError(e,c.ONBOARDING)}this._cleanUp()}catch(e){this._logError(e,c.REGISTER)}finally{m.migratingLegacyUser=!1}}async _migrateUser(){const e=await new Promise((e=>{chrome&&chrome.runtime?chrome.runtime.sendMessage({type:"legacyUserMigration",data:{tabId:a}},e):l({tabId:a,context:"test"},e)}));if(!e.success)throw new Error("Legacy User Migration register step failed",e.error);m.syncCoordinator.loadSettings(e.settings)}async _migrateFocuses(){await m.backgroundWorkerMessageBus.sendMessage({handler:"migrate",args:["focus",{env:{token:localStorage.getItem("token"),clientUuid:localStorage.getItem("client_uuid"),apiUrl:u,version:d,tabId:a}}]}),localStorage.setItem(s.FOCUS,"true")}async _saveOnboardingIntroAsComplete(){const t=(await e((async()=>{const{useOnboardingStore:e}=await import("./onboarding-Di5GE543.js").then((e=>e.f));return{useOnboardingStore:e}}),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39]))).useOnboardingStore();await t.saveStepProgress(o.FREE_INTRODUCTION,{status:"complete"}),localStorage.setItem(s.ONBOARDING,"true")}_logError(e,t){var a;new r(i).error("legacy user migration error",{errorMessage:e.message,stack:e.stack,errorName:e.name,errorType:typeof e,errorToString:null==(a=null==e?void 0:e.toString)?void 0:a.call(e),phase:t}),console.error(e)}_cleanUp(){localStorage.removeItem(s.ONBOARDING),localStorage.removeItem(s.FOCUS),localStorage.removeItem(s.TIME)}};export{I as l};
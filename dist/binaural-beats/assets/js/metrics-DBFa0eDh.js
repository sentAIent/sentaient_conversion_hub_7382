import{f as e,i as t,R as i,ae as a,af as r,ag as s,e as n,M as l,V as o,u as d,J as h}from"./dynamic-import-helper-CTnsj-vI.js";import{E as u,p as c}from"./errors-DV9ybRQO.js";import{a as p,g as v}from"./array-YYQw31d9.js";import{B as g}from"./BaseMetric-ClLQP9bU.js";import{c as y}from"./compareObjects-R6Hcs7xe.js";import{computed as w}from"./reactiveCustomization-CEUTOUc3.js";import{P as f}from"./pinia-B4IAWUO-.js";var I=(e=>(e.Never="none",e.Daily="daily",e.Weekly="weekly",e.Monthly="monthly",e.Yearly="yearly",e))(I||{}),T=(e=>(e.Manual="manual",e.Url="url",e.Integration="integration",e))(T||{});class D{constructor({id:e=p(),label:t="",value:i="",pinned:a=!1,archived:r=!1,rounding:s=null,random:n=!1,cycle:l="none",isTeam:o=!1,path:d=null,providerDataPointId:m=null,externalUrl:h=null,providerId:u=null,url:c=null,unit:v=null,readOnly:g=!1,icon:y,modifiedServer:w=(new Date).toISOString(),metricType:f}){this.id=e,this.label=t,this.value=i,this.rounding=s,this.cycle=l,this.path=d,this.providerDataPointId=m,this.externalUrl=h,this.providerId=u,this.url=c,this.unit=v,this.pinned=a,this.random=n,this.isTeam=o,this.readOnly=g,this.archived=r,this.icon=y??"goal",this.modifiedServer=w,this.metricType=f||(this.url?"url":this.providerId?"integration":"manual"),this.resetValueIfCycleElapsed()}compare(e){return y((null==e?void 0:e.serialize())??new D({id:this.id,modifiedServer:this.modifiedServer,metricType:this.metricType}).serialize(),this.serialize())}validate(){if("integration"===this.metricType&&null===this.providerId)throw new i({message:u.ProviderEmpty});if("integration"===this.metricType&&null===this.providerDataPointId)throw new i({message:u.ProviderValueInvalid,input:"value"});if(""===this.name)throw new i({message:u.NameEmpty,input:"name"});if("manual"===this.metricType&&""===this.value)throw new i({message:u.ValueEmpty,input:"value"});if("url"===this.metricType&&!this.url)throw new i({message:u.UrlEmpty,input:"url"});if("url"===this.metricType&&this.url&&!a(r(this.url)))throw new i({message:u.UrlInvalid,input:"url"})}serialize(){const e={...this};return delete e.metricType,e}get type(){return g.Metric}resetValueIfCycleElapsed(){"manual"===this.metricType&&this.cycle&&"none"!==this.cycle&&(i=>{const a=e().split(/\D/);if(!a[0]||!a[1]||!a[2])return new Date(0);const r=new Date(+a[0],+a[1]-1,+a[2]);r.setHours(t.dateRolloverHour);const s=new Date(r.getTime());if(i===I.Daily)return s;const n=new Date(r.getTime());if(n.setDate(n.getDate()-(n.getDay()+6)%7),i===I.Weekly)return n;const l=new Date(r.getTime());if(l.setDate(1),i===I.Monthly)return l;const o=new Date(r.getTime());return o.setDate(1),o.setMonth(0),i===I.Yearly?o:new Date(0)})(this.cycle).getTime()>new Date(this.modifiedServer).getTime()&&(s(this.value)?this.value="0":this.value="")}get name(){return this.label}set name(e){this.label=e}get displayTooltip(){return this.authNeeded?"Authorization Needed":this.externalUrl||""}get displayValue(){return"url"===this.metricType&&s(this.rounding)&&s(this.value)?Number(this.value).toFixed(this.rounding):this.authNeeded||""===this.value||null===this.value||void 0===this.value?"-":`${this.value+(this.unit??"")}`}get authNeeded(){return"integration"===this.metricType&&"Authorization needed."===this.value}get disableSave(){return!("integration"!==this.metricType||this.providerId&&this.providerDataPointId)}get shouldDisplayQuickAdjust(){return"manual"===this.metricType&&!this.isTeam&&!this.readOnly&&s(this.value)}}const M=((e=c().metricsService)=>{let t;const a=n("metrics",{plugins:[f.MockData],state:()=>({data:{},loading:!1,loaded:!1,activeItem:null,randomItems:[],selectedProviderId:""}),getters:{items:e=>Object.values(e.data).filter((e=>!e.archived)).map((e=>new D(e))).sort(((e,t)=>+t.pinned-+e.pinned)),unpinnedItems:e=>Object.values(e.data).filter((e=>!e.archived&&!e.pinned)).map((e=>new D(e))),pinnedItems:e=>Object.values(e.data).filter((e=>!e.archived&&e.pinned)).map((e=>new D(e))),archivedItems:e=>Object.values(e.data).filter((e=>e.archived)).map((e=>new D(e))),getItemById(e){const t=e.data;return e=>{const i=t[e];if(i)return new D(i)}},showRandom(){return 0===this.pinnedItems.length||!!w["showRandomMetric-metric"]}},actions:{clearActiveItem(){this.activeItem=null},setRandomItems(){!this.showRandom||this.unpinnedItems.length<=0?this.randomItems=[]:this.randomItems=[v(this.unpinnedItems)]},newItem(e=T.Manual){this.activeItem||(this.activeItem=new D({metricType:e}))},editItem(e){const t=this.data[e];if(!t)throw new i({message:`No metric found with id: ${e}`});this.activeItem=new D(t)},refresh(t){!(null==t?void 0:t.force)&&(this.loading||this.loaded&&!(null==t?void 0:t.archived))||(this.loading=!0,e.get({success:e=>{this.data=Object.fromEntries(e.map((e=>[e.id,e]))),this.loaded=!0,this.loading=!1},failure:()=>{this.loading=!1},...(null==t?void 0:t.archived)&&{queryParams:{includeArchived:"true"},mode:l.Server}}))},async create(t){o.set(this.data,t.id,t),await e.create(t)},async update(t,a){const r=this.data[t];if(!r)throw new i({message:`No metric found with id: ${t}`});o.set(this.data,t,{...r,...a}),await e.update(t,a)},async delete(t){o.delete(this.data,t),await e.delete(t)},async openItemOnTeamSite(t){let i=await e.getMetricServerId(t);i.toUpperCase().startsWith("T")&&(i=i.substring(1)),m.commandManager.execute("window.account.open.login",`/team/metric?id=${i}`)},getMetricUrlValues:async t=>(await e.getMetricUrlValues(r(t))).data.values,startMetricUpdateInterval(){const i=3e5,a=async()=>{const r=Number(localStorage.getItem("metrics:lastRefreshed")),s=(new Date).getTime();if(isNaN(r)||s-r>=i){localStorage.setItem("metrics:lastRefreshed",String(s)),clearTimeout(t);try{await e.refresh(),t=setTimeout((()=>{a()}),i)}catch(n){t=void 0,console.error(n)}}};clearTimeout(t),t=setTimeout((()=>{a()}),i)},stopMetricUpdateInterval(){clearTimeout(t)}}});return(async()=>{const e=a();await d((()=>e.loaded)).toBe(!0),h((()=>e.showRandom),(()=>{e.setRandomItems()})),h((()=>w.metricVisible),(t=>{t?e.startMetricUpdateInterval():e.stopMetricUpdateInterval()}))})(),a})(),b=Object.freeze(Object.defineProperty({__proto__:null,default:M,useMetricsStore:M},Symbol.toStringTag,{value:"Module"}));export{D as M,T as a,I as b,b as m,M as u};
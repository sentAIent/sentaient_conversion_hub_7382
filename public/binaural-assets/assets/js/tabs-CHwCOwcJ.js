import{d as t,K as e,aI as s,g as i,L as a,D as o,e as n,V as r}from"./dynamic-import-helper-CTnsj-vI.js";import{p as d}from"./promisifiedChrome-vBWwQWBS.js";import{a as w}from"./array-YYQw31d9.js";import{o as l}from"./modal-qMFaWR5h.js";class c{constructor({key:t,title:e,url:s,pinned:i,index:a}){this.type=h.Tab,this.key=t,this.title=e,this.url=s,this.pinned=i,this.index=a}}class u{constructor({key:t,tabs:e,index:s,color:i="grey",title:a="",collapsed:o=!1,manifestVersion:n}){this.type=h.Group,this.key=t,this.index=s,this.tabs=e.map((t=>new c(t))).sort(((t,e)=>t.index-e.index)),this.color=i,this.title=a,this.collapsed=o,this.manifestVersion=n||2}}var h=(t=>(t.Tab="Tab",t.Group="Group",t))(h||{});const p=["app","devtools"];class b{constructor({key:t,activeTabKey:e,state:s,type:i,left:a,top:o,width:n,height:r,browserSessionKey:d,tabsAndGroups:w}){this.tabsAndGroups=[],this.key=t,this.activeTabKey=e,this.state=s,this.type=i,this.left=a,this.top=o,this.width=n,this.height=r,d&&(this.browserSessionKey=d),this.tabsAndGroups=w.map((t=>"tabs"in t?new u(t):new c(t))).sort(((t,e)=>t.index-e.index))}get tabCount(){let t=0;return this.tabsAndGroups.forEach((e=>{t+=e instanceof c?1:e.tabs.length})),t}}const f=t=>{if(void 0!==t.id&&void 0!==t.state&&void 0!==t.type&&"app"!==t.type&&"devtools"!==t.type)return{key:t.id,state:t.state,type:t.type,left:t.left||0,top:t.top||0,width:t.width||window.outerWidth,height:t.height||window.outerHeight}};class y{constructor({id:t,name:e,windows:s,activeWindowKey:i,browser:a,dateCreated:o}){this.windows=[],this.id=t,this.name=e,this.windows=s.map((t=>new b(t))),this.activeWindowKey=i,this.browser=a,this.dateCreated=o}get totalTabCount(){return this.windows.map((t=>t.tabCount)).reduce(((t,e)=>t+e))}get displayName(){return this.name||t.getFriendlyDateTime(new Date(this.dateCreated))}get sessionDescriptionTabs(){const t=this.totalTabCount;return`${t} tab${t>1?"s":""}`}get sessionDescriptionWindows(){return`${this.windows.length} window${this.windows.length>1?"s":""}`}}var m=(t=>(t.List="list",t.Detail="detail",t))(m||{});const g={permissions:["tabs","sessions","tabGroups"]},v={permissions:["tabs","sessions"]},S={permissions:["tabs"],origins:["*://*/*"]},T={ERROR_STASH:"Oops, we couldn't save that session at this time.",ERROR_RESTORE:"Oops, we couldn't restore that session at this time.",ERROR_NO_OTHER_TABS:"No tabs to stash.",ERROR_DELETE:"Oops, there was a problem deleting that session.",ERROR_ALL_DELETE:"Oops, there was a problem deleting all sessions.",ERROR_PERMISSIONS:"Oops, we don't have permissions to do that.",SUCCESSFUL_STASH_PARTIAL:" saved to a new session.",SUCCESSFUL_RESTORE_PARTIAL:" session restored.",SUCCESSFUL_ALL_DELETE:"All session deleted.",DELETE_PARTIAL:" session deleted."},W="chrome://newtab/",E="https://get.momentumdash.help/hc/en-us/articles/14474141114391";var A="Chrome",I=(t=>(t.All="all",t.Window="window",t))(I||{});const R=()=>{switch(A){case"Firefox":return v;case"Safari":return S;default:return g}};class C{constructor(t){this.dataService=t}get(t){this.dataService.get(t)}create(t){return this.dataService.create(t.id,t)}update(t,e){return this.dataService.update(t,e)}delete(t){return this.dataService.delete(t)}async ensurePermissions(t=!1){const s=R();return!!(await d.permissions.contains(s))||l(s,{source:"Tab Stash",reason:"To save your tabs for later",requestImmediately:t,extraInstructions:e()?' Please select "Always allow on every website..."':"",watchPermissionCheck:!0})}async closeWindowsAndSetSessionIds(t){var s;for(const a of t.windows)if(e()){const t=a.tabsAndGroups.flatMap((t=>t.type===h.Tab?[t]:t.tabs)).map((t=>t.key));await d.tabs.remove(t)}else try{if(1===a.tabsAndGroups.length&&(null==(s=a.tabsAndGroups[0])?void 0:s.type)===h.Tab&&a.tabsAndGroups[0].url===W)await d.windows.remove(a.key);else{await d.windows.removeAndWaitForSessionChange(a.key);const t=await d.sessions.getLastClosedSessionId();t&&(a.browserSessionKey=t)}}catch(i){console.warn(i)}return t}async restoreSession(t){const s=t.windows.filter((e=>e.key!==t.activeWindowKey)),i=t.windows.filter((e=>e.key===t.activeWindowKey)),a=await d.permissions.contains(R()),o=await d.tabs.getCurrent();if(!o||!o.id)throw new Error("Could not find active tab id from current window");let n=o.windowId;for(const r of[...s,...i]){const s=r.key===t.activeWindowKey&&a&&1===(await d.tabs.query({currentWindow:!0})).length;if(e()&&s){for(const t of r.tabsAndGroups)await this.openPartialSession(t);n=o.windowId}else if(s){const e=await this.restoreWindow(r,t.browser);if(!e.id)continue;n=e.id,o.pinned&&await d.tabs.update(o.id,{pinned:!1}),await d.tabs.moveToWindow(o.id,e.id),o.pinned&&await d.tabs.update(o.id,{pinned:!0})}else await this.restoreWindow(r,t.browser)}await this.focusTabAndWindow(o.id,n)}async getSessionFromWindows(t){const i=await d.tabs.query({currentWindow:!0}),a=await d.tabs.getCurrent();if(!a||!a.id)throw new Error("could not find active tab id in current window");let o=-1;a&&1!==i.length&&a.id&&(e()||await this.pullTabInNewWindow(a),o=a.windowId);const n={id:w(),name:"",windows:[],activeWindowKey:o,browser:s(),dateCreated:(new Date).toISOString()},r=await d.windows.getAll({windowTypes:["normal"]});for(const e of r){if("window"===t&&e.id!==o)continue;const s=f(e);if(!s)throw new Error(`window returned by browser (${n.browser}) does not satisfy IWindow type`);const i=await this.setTabsDataForWindow(s,n.browser,a.id);i.tabsAndGroups.length&&n.windows.push(i)}return new y(n)}async openPartialSession(t){t instanceof b?await this.fallbackRestoreWindow(t,s()):t instanceof u?await this.createGroup(t):t instanceof c&&await d.tabs.create({url:t.url,pinned:t.pinned})}async createGroup(t){const e=[];for(const s of t.tabs){const t=await d.tabs.create({url:s.url,pinned:s.pinned});t.id&&e.push(t.id)}if(void 0!==chrome.tabs.group){const s=await d.tabs.group({tabIds:e});if(chrome.tabGroups&&3===t.manifestVersion){const{color:e,collapsed:i,title:a}=t;await chrome.tabGroups.update(s,{color:e,collapsed:i,title:a})}}}async pullTabInNewWindow(t){const e=t.id;if(!e)throw new Error("Could not read tab id when pulling out tab from window");const s=await d.windows.get(t.windowId),i=await d.windows.create({tabId:e});if(!i||!i.id)throw new Error("Could not create window when pulling out tab from window");await this.updateWindowSize(i.id,s),t.pinned&&await d.tabs.update(e,{pinned:!0})}async setTabsDataForWindow(t,s,i){var a;const o=await d.tabs.query({windowId:t.key}),n=o.map((t=>{const e=(t=>{if(void 0!==t.id&&void 0!==t.url)return{key:t.id,title:t.title||"",url:t.url,pinned:t.pinned,index:t.index,type:h.Tab}})(t);if(!e)throw new Error(`tab returned by browser (${s})could not be converted to ITab`);return e})).sort(((t,e)=>t.index-e.index)).filter((t=>t.key!==i)).filter((t=>!e()||!t.pinned)),r=[];for(let e=0;e<n.length;e++){const t=n[e],s=o[e];if(t&&s)if(~s.groupId&&void 0!==s.groupId){const t=o.filter((t=>t.groupId===s.groupId)).length;let i={};if(chrome&&chrome.tabGroups){const t=await chrome.tabGroups.get(s.groupId),{color:e,collapsed:a,title:o=""}=t;i={color:e,collapsed:a,title:o,manifestVersion:3}}const a={key:s.groupId,index:e,type:h.Group,tabs:n.slice(e,e+t),...i};e+=t-1,r.push(a)}else r.push(t)}return{...t,activeTabKey:(null==(a=o.find((t=>t.active)))?void 0:a.id)||-1,tabsAndGroups:r}}async restoreWindow(t,s){const i=t.browserSessionKey;let a;return i&&!e()&&(a=await d.sessions.restoreWindow(i)),a||(a=await this.fallbackRestoreWindow(t,s)),a}async fallbackRestoreWindow(t,e){var s,i,a,o,n;const{tabsAndGroups:r,activeTabKey:w,state:l,type:h}=t,b={state:l,type:h},f=r.flatMap((t=>t instanceof c?[t]:t.tabs));b.type&&p.includes(b.type)&&(b.type="normal"),b.url=await this.getUrlArrayForWindowCreateFromTabs(f,e);const y=await d.windows.create(b);if(!y||!y.id)throw new Error("Could not create window");if(await this.updateWindowSize(y.id,t),void 0!==chrome.tabs.group)for(const c of r){if(!(c instanceof u))continue;const t=c.index,e=t+c.tabs.length,i={tabIds:((null==(s=y.tabs)?void 0:s.slice(t,e))||[]).flatMap((t=>void 0===t.id?[]:[t.id])),createProperties:{windowId:y.id}},a=await d.tabs.group(i);if(chrome.tabGroups&&3===c.manifestVersion){const{color:t,collapsed:e,title:s}=c;await chrome.tabGroups.update(a,{color:t,collapsed:e,title:s})}}for(let c=0;c<f.length;c++){const t=f[c];if(null==t?void 0:t.pinned){const t=null==(a=null==(i=y.tabs)?void 0:i[c])?void 0:a.id;if(!t)continue;await d.tabs.update(t,{pinned:!0})}}const m=f.find((t=>t.key===w));if(m){const t=f.indexOf(m),e=null==(n=null==(o=y.tabs)?void 0:o[t])?void 0:n.id;e&&await d.tabs.update(e,{active:!0})}return y}async updateWindowSize(t,s){"normal"===s.state&&s.left&&s.width&&s.top&&s.height&&(await d.windows.update(t,{width:s.width,height:s.height}).catch((t=>console.error(t))),(!e()||window.screen.availWidth>s.left+s.width)&&await d.windows.update(t,{left:s.left,top:s.top}).catch((t=>console.error(t))))}async getUrlArrayForWindowCreateFromTabs(t,o){var n;const r=t=>t.startsWith(o+"-extension://")||t.startsWith(o+"://"),d=await(null==(n=i().extension)?void 0:n.isAllowedFileSchemeAccess()),w=t.map((t=>t.url===W&&(a()||e())?"/index.html":r(t.url)?t.url.replace(o,s()):t.url)).filter((t=>!(r(t)&&a()||t.startsWith("about:")))).filter((t=>!(t=>t.startsWith("file://"))(t)||d));return 0===w.length&&w.push("/index.html"),e()&&w.unshift("/index.html"),w}async focusTabAndWindow(t,e){t&&await d.tabs.update(t,{active:!0}),e&&await d.windows.update(e,{focused:!0})}}const G=()=>({tabStashService:new C(new o("tabs",{useUpdateMask:!0}))}),k=(t=G().tabStashService)=>n("tabs",{state:()=>({data:{},loading:!1,loaded:!1,activeItemId:""}),getters:{getItems:t=>Object.values(t.data).map((t=>new y(t))).sort(((t,e)=>Date.parse(e.dateCreated)-Date.parse(t.dateCreated))),getItemById:t=>e=>{const s=t.data[e];return s?new y(s):null}},actions:{refresh(){this.loading=!0,t.get({success:t=>{t.forEach((t=>r.set(this.data,t.id,t))),this.loaded=!0,this.loading=!1}})},async stashSession(s){if(!(await t.ensurePermissions()))return!1;const i=await t.getSessionFromWindows(s);return 0===i.windows.length||(await this.create(i),await t.closeWindowsAndSetSessionIds(i),e()||await this.update(i.id,{windows:i.windows})),i},async restoreSession(s){return!(!e()&&!(await t.ensurePermissions()))&&(await t.restoreSession(s),await this.delete(s.id),!0)},async create(e){r.set(this.data,e.id,e),await t.create(e)},async delete(e){r.delete(this.data,e),await t.delete(e)},async update(e,s){const i=this.data[e];if(!i)throw new Error(`No data found for ${e}`);const a={...i,...s};return r.set(this.data,e,a),await t.update(e,s),a},ensurePermissions:e=>t.ensurePermissions(e)}}),x=k(),O=Object.freeze(Object.defineProperty({__proto__:null,default:x,makeTabsStore:k,useTabsStore:x},Symbol.toStringTag,{value:"Module"}));export{u as G,E as H,W as N,y as S,m as T,b as W,c as a,h as b,I as c,T as m,G as p,O as t,x as u};
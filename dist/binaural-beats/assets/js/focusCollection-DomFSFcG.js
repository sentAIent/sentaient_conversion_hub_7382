import"./VueBase-C55TLWt3.js";import{i as e,b as t,m as o}from"./itemCollectionMixins-DB9fXink.js";import{V as i,D as s,d as a,M as c,A as d,f as n,T as u}from"./dynamic-import-helper-CTnsj-vI.js";import{persistent as l}from"./reactiveCustomization-CEUTOUc3.js";import{loadTodoAddin as r}from"./addin-CPXlL2UQ.js";import"./_commonjsHelpers-B3K3fdV-.js";import"./ClickOutside-DCLvi2fj.js";import"./pinia-B4IAWUO-.js";import"./portal-vue.esm-DdddSpdW.js";import"./array-YYQw31d9.js";import"./style-D-IRYiWS.js";import"./Logger-cMW5At62.js";import"./string-BBKP9xfj.js";import"./modal-qMFaWR5h.js";import"./enums-1c3kgXdw.js";import"./tasksViewState-qOrGChOD.js";import"./ViewState-DH0LvQYq.js";import"./appZStack-Zxx-wHpo.js";import"./handlebarLoader-xbtIzd6B.js";const h=i.extend({name:"FocusModel",mixins:[e],data:()=>({id:null,archived:!1,completed:!1,createdDate:m.now(),focus:null,forDate:null,todoId:null,props:["focus","completed","archived","forDate","createdDate","todoId"]}),methods:{updateData(t){e.methods.updateData.call(this,t),this.completed=!!t.completed}}}),v=new(i.extend({name:"AutoFocusManager",data:()=>({activeFocus:null,loaded:!1,loading:!1}),computed:{autoFocusEnabled:()=>l.autoFocus&&m.conditionalFeatures.featureEnabled("pinfocus")},watch:{autoFocusEnabled:{async handler(e){e?(this.loaded||this.loading||await this.getInitialLoadedState(),this.getTopTodo().then((e=>this.activeFocus=this.createFocusFromTodo(e)))):this.activeFocus=null},immediate:!0},"activeFocus.focus"(e){this.activeFocus&&m.trigger("todo:set:title",this.activeFocus.todoId,e)}},created(){m.on("todo:globalChange",this.onTodoChange),m.on("todo:loadingStateChange",this.onLoadingStateChange),m.on("todo:activeListLoaded",this.setLoaded)},destroyed(){m.off("todo:globalChange",this.onTodoChange),m.off("todo:loadingStateChange",this.onLoadingStateChange),m.off("todo:activeListLoaded",this.setLoaded)},methods:{async getInitialLoadedState(){var e,t;this.loading=!0,await r(),"Done"===(null==(t=null==(e=m.views.todoPane.manager.activeProvider.selectedList())?void 0:e.itemCollection)?void 0:t.listStatus)&&this.setLoaded()},setLoaded(){this.loading=!1,this.loaded=!0},toggleComplete(){this.activeFocus&&(this.activeFocus.completed=!this.activeFocus.completed,m.trigger("todo:set:done",this.activeFocus.todoId,this.activeFocus.completed))},onLoadingStateChange(){this.autoFocusEnabled&&this.getTopTodo().then((e=>{var t;!e||this.activeFocus&&(e.get("id")||e.id)===this.activeFocus.todoId?e||(null==(t=this.activeFocus)?void 0:t.completed)||(this.activeFocus=null):this.activeFocus=this.createFocusFromTodo(e)}))},getTopTodo:async()=>(await r(),m.views.todoPane.getTopTodo()),onTodoChange(...e){var t,o,i,s,a;const c=e[0];if(e.find((e=>e&&(e.ignoreRender||e.silent)))||!this.autoFocusEnabled||!(null==c?void 0:c.changed)||!Object.keys(c.changed).length||!1===(null==(t=c.changed)?void 0:t.isLoading))return;const d=(null==(o=c.changed)?void 0:o.completedDate)||(null==(i=c.changed)?void 0:i.modifiedServer)||(null==(a=null==(s=null==c?void 0:c.changed)?void 0:s.changed_props)?void 0:a.includes("completedDate"));this.getTopTodo().then((e=>{var t,o;e?this.activeFocus=this.createFocusFromTodo(e):(null==(t=this.activeFocus)?void 0:t.todoId)&&(c.get("id")||c.id).includes(null==(o=this.activeFocus)?void 0:o.todoId)&&(this.activeFocus.completed=c.get("done"),d||(this.activeFocus=null))}))},createFocusFromTodo(e){if(!e)return null;let t=new h;return t.updateData({focus:e.get("title"),archived:!1,completed:e.get("done"),createdDate:m.now(),id:m.utils.uuidv4(),todoId:e.get("id")||e.id,forDate:m.utils.getDateString()}),t}}}));class p{constructor(e){this.dataService=e}get(e){this.dataService.get(e)}add(e,t){return this.dataService.create(e,t)}update(e,t){return this.dataService.update(e,t)}delete(e){return this.dataService.delete(e)}refresh(){return this.dataService.refresh()}}const g=new(i.extend({name:"FocusCollection",mixins:[t,o],setup:()=>({completeCounter:0,resetCompleteDebounce:null,type:"focus",Model:h,dataService:new p(new s("focus",{mode:a.userIsLegacyUnregistered()?c.Cache:c.Timestamp})),newModel:null,analytics:new d({feature:"focus"})}),computed:{emptyFocus(){return!this.activeFocus.focus},activeFocusInCollection(){const e=a.getDateString(),t=Object.values(this.data.items).filter((t=>!t.archived&&t.forDate===e)).sort(((e,t)=>t.createdDate-e.createdDate));return t.length?t[0]:null},activeFocus(){return v.activeFocus||this.activeFocusInCollection||this.newModel},loaded(){return(!v.autoFocusEnabled||v.loaded)&&this.data.loaded}},created(){this.instantiateNewModel(),m.on("focus:pin",this.onFocusPin),m.on("todo:globalChange",this.onTodoChange),m.on("newDay",this.archivePreviousFocuses)},destroyed(){m.off("focus:pin",this.onFocusPin),m.off("todo:globalChange",this.onTodoChange),m.off("newDay",this.archivePreviousFocuses)},methods:{instantiateNewModel(){this.newModel=new this.Model,this.newModel.copyProperties()},async save(){const e=this.emptyFocus;v.activeFocus||this.activeFocus.editProps.focus&&await this[this.emptyFocus?"add":"update"](this.activeFocus),e&&this.instantiateNewModel(),(this.activeFocus.focus||this.activeFocus.editProps.focus)&&this.analytics.capture("focus "+(e?"add":"edit"),{position:localStorage.getItem("pomodoro-showing")?"pomodoro":"default"}),this.activeFocus.commitChanges(),this.activeFocus.todoId&&m.trigger("todo:set:title",this.activeFocus.todoId,this.activeFocus.focus)},archive(e=!1){e&&this.analytics.capture("focus clear",{completed:this.activeFocus.completed}),v.activeFocus?l.autoFocus=!1:this.activeFocus.id&&t.methods.archive.call(this,this.activeFocus)},archivePreviousFocuses(){const e=n();Object.values(this.data.items).forEach((o=>{!o.archived&&e>o.forDate&&t.methods.archive.call(this,o)}))},toggleComplete(){const e=this.activeFocus.completed;if(this.completeCounter++,clearTimeout(this.resetCompleteDebounce),this.resetCompleteDebounce=setTimeout((()=>{this.completeCounter=0}),100),10===this.completeCounter){new u("tab.focus.complete").warn(new Error("Focus complete/uncomplete loop detected"))}else if(this.completeCounter>10)return void console.warn("Many focu complet");this.analytics.capture("focus "+(e?"uncomplete":"complete"),Object.assign({position:localStorage.getItem("pomodoro-showing")?"pomodoro":"default"},e?{}:{autofocus:v.autoFocusEnabled})),!v.activeFocus&&this.activeFocus.id?(this.activeFocus.completed=!e,this.dataService.update(this.activeFocus.id,{completed:!e}).then((()=>{this.activeFocus.todoId&&m.trigger("todo:set:done",this.activeFocus.todoId,!e)})).catch((t=>{throw this.activeFocus.completed=e,t}))):v.toggleComplete()},onFocusPin(e){l.autoFocus=!1;let t=v.createFocusFromTodo(e);t&&t.focus&&(t.copyProperties(),this.add(t))},onTodoChange(...e){var t,o;const i=e[0];if(e.find((e=>e&&(e.ignoreRender||e.silent)))||!this.activeFocus||!Object.keys(this.data.items).length||!(null==i?void 0:i.changed))return;let s=Object.values(this.data.items).find((e=>{var t;return e.todoId&&e.todoId===((null==(t=i.get)?void 0:t.call(i,"id"))||(null==i?void 0:i.id))}));if(!s)return;if(null==(o=null==(t=e[0])?void 0:t.changed)?void 0:o.deleted)return void this.archive();const a=i.get("done"),c=i.get("title");s.completed===a&&s.focus===c||(s.completed=a,s.focus=c,this.dataService.update(s.id,{completed:a,focus:c}))}}}));export{g as default};